<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>commands.test &#8212; salomeTools 5.0.0dev documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.0.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="salomeTools 5.0.0dev documentation" href="../../index.html" />
    <link rel="up" title="commands" href="../commands.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for commands.test</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*- coding:utf-8 -*-</span>

<span class="c1">#  Copyright (C) 2010-2012  CEA/DEN</span>
<span class="c1">#</span>
<span class="c1">#  This library is free software; you can redistribute it and/or</span>
<span class="c1">#  modify it under the terms of the GNU Lesser General Public</span>
<span class="c1">#  License as published by the Free Software Foundation; either</span>
<span class="c1">#  version 2.1 of the License.</span>
<span class="c1">#</span>
<span class="c1">#  This library is distributed in the hope that it will be useful,</span>
<span class="c1">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c1">#  Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#  You should have received a copy of the GNU Lesser General Public</span>
<span class="c1">#  License along with this library; if not, write to the Free Software</span>
<span class="c1">#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="kn">import</span> <span class="nn">src.debug</span> <span class="k">as</span> <span class="nn">DBG</span>
<span class="kn">import</span> <span class="nn">src.returnCode</span> <span class="k">as</span> <span class="nn">RCO</span>
<span class="kn">import</span> <span class="nn">src.utilsSat</span> <span class="k">as</span> <span class="nn">UTS</span>
<span class="kn">from</span> <span class="nn">src.salomeTools</span> <span class="k">import</span> <span class="n">_BaseCommand</span>
<span class="kn">import</span> <span class="nn">src.ElementTree</span> <span class="k">as</span> <span class="nn">etree</span>
<span class="kn">import</span> <span class="nn">src.xmlManager</span> <span class="k">as</span> <span class="nn">XMLMGR</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">sha1</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sha</span> <span class="k">import</span> <span class="n">sha</span> <span class="k">as</span> <span class="n">sha1</span>


<span class="c1">########################################################################</span>
<span class="c1"># Command class</span>
<span class="c1">########################################################################</span>
<div class="viewcode-block" id="Command"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.Command">[docs]</a><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">_BaseCommand</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  The test command runs a test base on a SALOME installation.</span>
<span class="sd">  </span>
<span class="sd">  | examples:</span>
<span class="sd">  | &gt;&gt; sat test SALOME --grid GEOM --session light</span>
<span class="sd">  &quot;&quot;&quot;</span>
  
  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
  
<div class="viewcode-block" id="Command.getParser"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.Command.getParser">[docs]</a>  <span class="k">def</span> <span class="nf">getParser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define all options for command &#39;sat test &lt;options&gt;&#39;&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParserWithHelp</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Optional: Indicate the name of the test base to use.</span>
<span class="s2">  This name has to be registered in your application and in a project.</span>
<span class="s2">  A path to a test base can also be used.&quot;&quot;&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;launcher&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;launcher&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Optional: Use this option to specify the path to a SALOME launcher to &quot;</span>
          <span class="s2">&quot;use to launch the test scripts of the test base.&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;grids&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Optional: Indicate which grid(s) to test (subdirectory of the test base).&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;sessions&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Optional: indicate which session(s) to test (subdirectory of the grid).&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Optional: set the display where to launch SALOME.</span>
<span class="s2">  If value is NO then option --show-desktop=0 will be used to launch SALOME.&quot;&quot;&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="Command.check_option"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.Command.check_option">[docs]</a>  <span class="k">def</span> <span class="nf">check_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check the options</span>
<span class="sd">    </span>
<span class="sd">    :param options: (Options) The options</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">launcher</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">launcher</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">launcher</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="o">.</span><span class="n">config_has_application</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;An application is required to use a relative path with option --appli&quot;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">launcher</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">launcher</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">launcher</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Launcher not found: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">launcher</span> <span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="Command.run"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.Command.run">[docs]</a>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_arguments</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;method called for command &#39;sat test &lt;options&gt;&#39;&quot;&quot;&quot;</span>
    <span class="n">argList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assumeAsList</span><span class="p">(</span><span class="n">cmd_arguments</span><span class="p">)</span>

    <span class="c1"># print general help and returns</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;No arguments, as &#39;sat </span><span class="si">%s</span><span class="s2"> --help&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      
    <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">,</span> <span class="n">remaindersArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseArguments</span><span class="p">(</span><span class="n">argList</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;Done &#39;sat </span><span class="si">%s</span><span class="s2"> --help&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
   
    <span class="c1"># shortcuts</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRunner</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConfig</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOptions</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">check_option</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

    <span class="c1"># the test base is specified either by the application, or by the --base option</span>
    <span class="n">with_application</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">application</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Running tests on application </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> 
                     <span class="n">UTS</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">application</span><span class="p">))</span>
        <span class="n">with_application</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">base</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
          <span class="n">_</span><span class="p">(</span><span class="s1">&#39;A test base is required. Use the --base option&#39;</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># the launcher is specified either by the application, or by the --launcher option</span>
    <span class="k">if</span> <span class="n">with_application</span><span class="p">:</span>
        <span class="c1"># check if environment is loaded</span>
        <span class="k">if</span> <span class="s1">&#39;KERNEL_ROOT_DIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;SALOME environment already sourced&quot;</span><span class="p">))</span>
              
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">launcher</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Running SALOME application.&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Impossible to find any launcher.</span>
<span class="s2">Please specify an application or a launcher</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="c1"># set the display</span>
    <span class="n">show_desktop</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">display</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NO&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">display</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">display</span> <span class="o">!=</span> <span class="s2">&quot;NO&quot;</span><span class="p">:</span>
        <span class="n">remote_name</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">remote_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">check_remote_machine</span><span class="p">(</span><span class="n">remote_name</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="c1"># if explicitly set use user choice</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DISPLAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">display</span>
    <span class="k">elif</span> <span class="s1">&#39;DISPLAY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="c1"># if no display set</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">LOCAL</span> <span class="ow">and</span>
                <span class="s1">&#39;display&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">LOCAL</span><span class="o">.</span><span class="n">test</span> <span class="ow">and</span> 
                <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">LOCAL</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">display</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># use default value for test tool</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DISPLAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">LOCAL</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">display</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DISPLAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;localhost:0.0&quot;</span>

    <span class="c1"># initialization</span>
    <span class="c1">#################</span>
    <span class="k">if</span> <span class="n">with_application</span><span class="p">:</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">tmp_root</span><span class="p">,</span>
                               <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">tmp_root</span><span class="p">,</span>
                               <span class="s2">&quot;test&quot;</span><span class="p">)</span>

    <span class="c1"># remove previous tmp dir</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;error removing TT_TMP_RESULT </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">tmp_dir</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;date = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;hour = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;node = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;arch = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;APPLICATION&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;application_info = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;application_info[&#39;name&#39;] = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> 
                     <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;application_info[&#39;tag&#39;] = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> 
                     <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;application_info[&#39;products&#39;] = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> 
                     <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">products</span><span class="p">))</span>

    <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1"># create hash from context information</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TT_TMP_RESULT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_dir</span>

    <span class="c1"># create env_info file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;env_info.py&#39;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># create working dir and bases dir</span>
    <span class="n">working_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;WORK&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;BASES&#39;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;PYTHONPATH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="c1"># launch of the tests</span>
    <span class="c1">#####################</span>
    <span class="n">test_base</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">base</span><span class="p">:</span>
        <span class="n">test_base</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">base</span>
    <span class="k">elif</span> <span class="n">with_application</span> <span class="ow">and</span> <span class="s2">&quot;test_base&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="p">:</span>
        <span class="n">test_base</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">test_base</span><span class="o">.</span><span class="n">name</span>

    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span>  <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Display&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DISPLAY&#39;</span><span class="p">])</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Timeout&#39;</span><span class="p">),</span> <span class="n">src</span><span class="o">.</span><span class="n">test_module</span><span class="o">.</span><span class="n">DEFAULT_TIMEOUT</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Working dir&quot;</span><span class="p">),</span> <span class="n">base_dir</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># create the test object</span>
    <span class="n">test_runner</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">test_module</span><span class="o">.</span><span class="n">Test</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                  <span class="n">logger</span><span class="p">,</span>
                                  <span class="n">base_dir</span><span class="p">,</span>
                                  <span class="n">testbase</span><span class="o">=</span><span class="n">test_base</span><span class="p">,</span>
                                  <span class="n">grids</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">grids</span><span class="p">,</span>
                                  <span class="n">sessions</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">sessions</span><span class="p">,</span>
                                  <span class="n">launcher</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">launcher</span><span class="p">,</span>
                                  <span class="n">show_desktop</span><span class="o">=</span><span class="n">show_desktop</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">test_runner</span><span class="o">.</span><span class="n">test_base_found</span><span class="p">:</span>
        <span class="c1"># Fail </span>
        <span class="k">return</span> <span class="mi">1</span>
        
    <span class="c1"># run the test</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">allowPrintLevel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">retcode</span> <span class="o">=</span> <span class="n">test_runner</span><span class="o">.</span><span class="n">run_all_tests</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">allowPrintLevel</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Tests finished</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Generate the specific test log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">UTS</span><span class="o">.</span><span class="n">get_log_path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s2">&quot;TEST&quot;</span><span class="p">)</span>
    <span class="n">UTS</span><span class="o">.</span><span class="n">ensure_path_exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">name_xml_board</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">logFileName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;board&quot;</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span>
    <span class="n">historic_xml_path</span> <span class="o">=</span> <span class="n">generate_history_xml_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">test_base</span><span class="p">)</span>
    
    <span class="n">create_test_report</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                       <span class="n">historic_xml_path</span><span class="p">,</span>
                       <span class="n">out_dir</span><span class="p">,</span>
                       <span class="n">retcode</span><span class="p">,</span>
                       <span class="n">xmlname</span> <span class="o">=</span> <span class="n">name_xml_board</span><span class="p">)</span>
    <span class="n">xml_board_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name_xml_board</span><span class="p">)</span>

    <span class="c1"># OP 14/11/2017 Ajout de traces pour essayer de decouvrir le pb</span>
    <span class="c1">#               de remontee de log des tests</span>
    <span class="nb">print</span> <span class="s2">&quot;TRACES OP - test.py/run() : historic_xml_path = &#39;#</span><span class="si">%s</span><span class="s2">#&#39;&quot;</span> <span class="o">%</span><span class="n">historic_xml_path</span>
    <span class="nb">print</span> <span class="s2">&quot;TRACES OP - test.py/run() : log_dir           = &#39;#</span><span class="si">%s</span><span class="s2">#&#39;&quot;</span> <span class="o">%</span><span class="n">log_dir</span>
    <span class="nb">print</span> <span class="s2">&quot;TRACES OP - test.py/run() : name_xml_board    = &#39;#</span><span class="si">%s</span><span class="s2">#&#39;&quot;</span> <span class="o">%</span><span class="n">name_xml_board</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">l_logFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xml_board_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;TEST&quot;</span><span class="p">,</span> <span class="n">name_xml_board</span><span class="p">),</span>
                    <span class="s2">&quot;board&quot;</span><span class="p">,</span>
                    <span class="n">retcode</span><span class="p">,</span>
                    <span class="s2">&quot;Click on the link to get the detailed test results&quot;</span><span class="p">)</span>
    
    <span class="c1"># Add the historic files into the log files list of the command</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">l_logFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historic_xml_path</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Removing the temporary directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">test_runner</span><span class="o">.</span><span class="n">tmp_working_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_runner</span><span class="o">.</span><span class="n">tmp_working_dir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">test_runner</span><span class="o">.</span><span class="n">tmp_working_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">retcode</span></div></div>
   

<div class="viewcode-block" id="ask_a_path"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.ask_a_path">[docs]</a><span class="k">def</span> <span class="nf">ask_a_path</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    interactive as using &#39;raw_input&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;enter a path where to save the result: &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;the result will be not save. Are you sure to &quot;</span>
                           <span class="s2">&quot;continue ? [y/n] &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ask_a_path</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;WARNING: the content of </span><span class="si">%s</span><span class="s2"> will be deleted. Are you&quot;</span>
                           <span class="s2">&quot; sure to continue ? [y/n] &quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ask_a_path</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="save_file"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.save_file">[docs]</a><span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">objectname</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;.objects&#39;</span><span class="p">,</span> <span class="n">objectname</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">objectname</span></div>

<div class="viewcode-block" id="move_test_results"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.move_test_results">[docs]</a><span class="k">def</span> <span class="nf">move_test_results</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">out_dir</span> <span class="o">==</span> <span class="n">in_dir</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">finalPath</span> <span class="o">=</span> <span class="n">out_dir</span>
    <span class="n">pathIsOk</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">pathIsOk</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create test results directory if necessary</span>
            <span class="c1">#logger.debug(&quot;FINAL = %s\n&quot; % finalPath)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">finalPath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
                <span class="c1">#shutil.rmtree(finalPath)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">finalPath</span><span class="p">)</span>
            <span class="n">pathIsOk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> cannot be created.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">finalPath</span><span class="p">)</span>
            <span class="n">finalPath</span> <span class="o">=</span> <span class="n">ask_a_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">finalPath</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finalPath</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="s1">&#39;BASES&#39;</span><span class="p">))</span>

        <span class="c1"># check if .objects directory exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finalPath</span><span class="p">,</span> <span class="s1">&#39;.objects&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finalPath</span><span class="p">,</span> <span class="s1">&#39;.objects&#39;</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;copy tests results to </span><span class="si">%s</span><span class="s1"> ... &#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">finalPath</span><span class="p">)</span>

        <span class="c1"># copy env_info.py</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="s1">&#39;env_info.py&#39;</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finalPath</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="s1">&#39;env_info.py&#39;</span><span class="p">))</span>

        <span class="c1"># for all sub directory (ie testbase) in the BASES directory</span>
        <span class="k">for</span> <span class="n">testbase</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="s1">&#39;BASES&#39;</span><span class="p">)):</span>
            <span class="n">outtestbase</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finalPath</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="s1">&#39;BASES&#39;</span><span class="p">,</span> <span class="n">testbase</span><span class="p">)</span>
            <span class="n">intestbase</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="s1">&#39;BASES&#39;</span><span class="p">,</span> <span class="n">testbase</span><span class="p">)</span>

            <span class="c1"># ignore files in root dir</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">intestbase</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outtestbase</span><span class="p">)</span>
            <span class="c1">#logger.debug(&quot;copy testbase %s\n&quot; % testbase)</span>

            <span class="k">for</span> <span class="n">grid_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">intestbase</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intestbase</span><span class="p">,</span> <span class="n">m</span><span class="p">))]:</span>
                <span class="c1"># ignore source configuration directories</span>
                <span class="k">if</span> <span class="n">grid_</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.git&#39;</span> <span class="ow">or</span> <span class="n">grid_</span> <span class="o">==</span> <span class="s1">&#39;CVS&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">outgrid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outtestbase</span><span class="p">,</span> <span class="n">grid_</span><span class="p">)</span>
                <span class="n">ingrid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intestbase</span><span class="p">,</span> <span class="n">grid_</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outgrid</span><span class="p">)</span>
                <span class="c1">#logger.debug(&quot;copy grid %s&quot; % grid_)</span>

                <span class="k">if</span> <span class="n">grid_</span> <span class="o">==</span> <span class="s1">&#39;RESSOURCES&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ingrid</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ingrid</span><span class="p">,</span>
                                                           <span class="n">file_name</span><span class="p">)):</span>
                            <span class="k">continue</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outgrid</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ingrid</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                                          <span class="n">finalPath</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">session_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ingrid</span><span class="p">)</span> <span class="k">if</span> 
                                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ingrid</span><span class="p">,</span> <span class="n">t</span><span class="p">))]:</span>
                        <span class="n">outsession</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outgrid</span><span class="p">,</span> <span class="n">session_name</span><span class="p">)</span>
                        <span class="n">insession</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ingrid</span><span class="p">,</span> <span class="n">session_name</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outsession</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">insession</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insession</span><span class="p">,</span>
                                                               <span class="n">file_name</span><span class="p">)):</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;result.py&#39;</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insession</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                                             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outsession</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outsession</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insession</span><span class="p">,</span>
                                                               <span class="n">file_name</span><span class="p">),</span>
                                                  <span class="n">finalPath</span><span class="p">))</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&lt;OK&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="check_remote_machine"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.check_remote_machine">[docs]</a><span class="k">def</span> <span class="nf">check_remote_machine</span><span class="p">(</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Check the display on </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">machine_name</span><span class="p">)</span>
    <span class="n">ssh_cmd</span> <span class="o">=</span> <span class="s1">&#39;ssh -o &quot;StrictHostKeyChecking no&quot; </span><span class="si">%s</span><span class="s1"> &quot;ls&quot;&#39;</span> <span class="o">%</span> <span class="n">machine_name</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Executing the command : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">ssh_cmd</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">,</span> 
                         <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">stdin</span> <span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                         <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                         <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&lt;KO&gt; on &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">ssh_cmd</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No ssh access to the display machine </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">machine_name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&lt;OK&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_test_report"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.create_test_report">[docs]</a><span class="k">def</span> <span class="nf">create_test_report</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                       <span class="n">xml_history_path</span><span class="p">,</span>
                       <span class="n">dest_path</span><span class="p">,</span>
                       <span class="n">retcode</span><span class="p">,</span>
                       <span class="n">xmlname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the XML report for a product.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the date and hour of the launching of the command, in order to keep</span>
    <span class="c1"># history</span>
    <span class="n">date_hour</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">datehour</span>
    
    <span class="c1"># Get some information to put in the xml file</span>
    <span class="n">application_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">application</span>
    <span class="n">withappli</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">config_has_application</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    
    <span class="n">first_time</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xml_history_path</span><span class="p">):</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;salome&quot;</span><span class="p">)</span>
        <span class="n">prod_node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;product&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">application_name</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="n">xmlname</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prod_node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_history_path</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="n">prod_node</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;product&quot;</span><span class="p">)</span>
    
    <span class="n">prod_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;history_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">xml_history_path</span><span class="p">)</span>
    <span class="n">prod_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;global_res&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retcode</span>
    
    <span class="n">ASNODE</span> <span class="o">=</span> <span class="n">XMLMGR</span><span class="o">.</span><span class="n">add_simple_node</span> <span class="c1"># shortcut</span>
    
    <span class="k">if</span> <span class="n">withappli</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_time</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prod_node</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;version_to_download&quot;</span><span class="p">)</span> <span class="o">+</span> 
                         <span class="n">prod_node</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;out_dir&quot;</span><span class="p">)):</span>
                <span class="n">prod_node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                
        <span class="n">ASNODE</span><span class="p">(</span><span class="n">prod_node</span><span class="p">,</span> <span class="s2">&quot;version_to_download&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        
        <span class="n">ASNODE</span><span class="p">(</span><span class="n">prod_node</span><span class="p">,</span> <span class="s2">&quot;out_dir&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

    <span class="c1"># add environment</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_time</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">prod_node</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;exec&quot;</span><span class="p">):</span>
                <span class="n">prod_node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        
    <span class="n">exec_node</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">prod_node</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span>
    <span class="n">exec_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Host&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">node</span><span class="p">))</span>
    <span class="n">exec_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Architecture&quot;</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">dist</span><span class="p">))</span>
    <span class="n">exec_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Number of processors&quot;</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">nb_proc</span><span class="p">)))</span>    
    <span class="n">exec_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Begin date&quot;</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">date_hour</span><span class="p">)))</span>
    <span class="n">exec_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Command&quot;</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>
    <span class="n">exec_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sat version&quot;</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">INTERNAL</span><span class="o">.</span><span class="n">sat_version</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;TESTS&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
            <span class="n">tests</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">prod_node</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">)</span>
            <span class="n">known_errors</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">prod_node</span><span class="p">,</span> <span class="s2">&quot;known_errors&quot;</span><span class="p">)</span>
            <span class="n">new_errors</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">prod_node</span><span class="p">,</span> <span class="s2">&quot;new_errors&quot;</span><span class="p">)</span>
            <span class="n">amend</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">prod_node</span><span class="p">,</span> <span class="s2">&quot;amend&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tests</span> <span class="o">=</span> <span class="n">prod_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;tests&quot;</span><span class="p">)</span>
            <span class="n">known_errors</span> <span class="o">=</span> <span class="n">prod_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;known_errors&quot;</span><span class="p">)</span>
            <span class="n">new_errors</span> <span class="o">=</span> <span class="n">prod_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;new_errors&quot;</span><span class="p">)</span>
            <span class="n">amend</span> <span class="o">=</span> <span class="n">prod_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;amend&quot;</span><span class="p">)</span>
        
        <span class="n">tt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">TESTS</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tt</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">testbase</span><span class="p">):</span>
                <span class="n">tt</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">testbase</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tt</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">testbase</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">testbase</span> <span class="ow">in</span> <span class="n">tt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                <span class="n">gn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="s2">&quot;testbase&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gn</span> <span class="o">=</span> <span class="n">tests</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;testbase&quot;</span><span class="p">)</span>
                <span class="c1"># initialize all grids and session to &quot;not executed&quot;</span>
                <span class="k">for</span> <span class="n">mn</span> <span class="ow">in</span> <span class="n">gn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">):</span>
                    <span class="n">mn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;executed_last_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
                    <span class="k">for</span> <span class="n">tyn</span> <span class="ow">in</span> <span class="n">mn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">):</span>
                        <span class="n">tyn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;executed_last_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
                        <span class="k">for</span> <span class="n">test_node</span> <span class="ow">in</span> <span class="n">tyn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">test_node</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span>
                                    <span class="n">test_node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                            
                            <span class="n">attribs_to_pop</span> <span class="o">=</span> <span class="p">[]</span>    
                            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">test_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">!=</span> <span class="s2">&quot;script&quot;</span> <span class="ow">and</span> 
                                                        <span class="n">attribute</span> <span class="o">!=</span> <span class="s2">&quot;res&quot;</span><span class="p">):</span>
                                    <span class="n">attribs_to_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attribs_to_pop</span><span class="p">:</span>
                                <span class="n">test_node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
            
            <span class="n">gn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">testbase</span>
            <span class="n">nb</span><span class="p">,</span> <span class="n">nb_pass</span><span class="p">,</span> <span class="n">nb_failed</span><span class="p">,</span> <span class="n">nb_timeout</span><span class="p">,</span> <span class="n">nb_not_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">grids</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sessions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">[</span><span class="n">testbase</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">grids</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                        <span class="n">mn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">gn</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">)</span>
                        <span class="n">mn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">grid</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l_mn</span> <span class="o">=</span> <span class="n">gn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">)</span>
                        <span class="n">mn</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">grid_node</span> <span class="ow">in</span> <span class="n">l_mn</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">grid_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>
                                <span class="n">mn</span> <span class="o">=</span> <span class="n">grid_node</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">mn</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">mn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">gn</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">)</span>
                            <span class="n">mn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">grid</span>
                    
                    <span class="n">grids</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">]</span> <span class="o">=</span> <span class="n">mn</span>
                
                <span class="n">mn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;executed_last_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sessions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                        <span class="n">tyn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">)</span>
                        <span class="n">tyn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l_tyn</span> <span class="o">=</span> <span class="n">mn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
                        <span class="n">tyn</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">session_node</span> <span class="ow">in</span> <span class="n">l_tyn</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">session_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
                                <span class="n">tyn</span> <span class="o">=</span> <span class="n">session_node</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">tyn</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tyn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">)</span>
                            <span class="n">tyn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span>
                        
                    <span class="n">sessions</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tyn</span>

                <span class="n">tyn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;executed_last_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>

                <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">script</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                        <span class="n">tn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span>
                                           <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">)],</span>
                                             <span class="s2">&quot;test&quot;</span><span class="p">)</span>
                        <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span>
                        <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">name</span>
                        <span class="n">hn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l_tn</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">)]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                                                                         <span class="s2">&quot;test&quot;</span><span class="p">)</span>
                        <span class="n">tn</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">test_node</span> <span class="ow">in</span> <span class="n">l_tn</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">test_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">script</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                                <span class="n">tn</span> <span class="o">=</span> <span class="n">test_node</span>
                                <span class="k">break</span>
                        
                        <span class="k">if</span> <span class="n">tn</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span>
                                           <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">)],</span>
                                             <span class="s2">&quot;test&quot;</span><span class="p">)</span>
                            <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">session</span>
                            <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">name</span>
                            <span class="n">hn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Get or create the history node for the current test</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;history&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">hn</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">hn</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;history&quot;</span><span class="p">)</span>
                            <span class="c1"># Put the last test data into the history</span>
                            <span class="k">if</span> <span class="s1">&#39;res&#39;</span> <span class="ow">in</span> <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                                <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;date_hour&quot;</span> <span class="p">:</span> <span class="n">date_hour</span><span class="p">,</span>
                                              <span class="s2">&quot;res&quot;</span> <span class="p">:</span> <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="p">}</span>
                                <span class="n">ASNODE</span><span class="p">(</span><span class="n">hn</span><span class="p">,</span>
                                                <span class="s2">&quot;previous_test&quot;</span><span class="p">,</span>
                                                <span class="n">attrib</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tn</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span>
                                    <span class="n">tn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="s1">&#39;callback&#39;</span> <span class="ow">in</span> <span class="n">script</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">cnode</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;callback&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
                                <span class="kn">import</span> <span class="nn">string</span>
                                <span class="n">cnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
                                                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span><span class="p">,</span>
                                                <span class="n">script</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">callback</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                                                                <span class="s1">&#39;string_escape&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                            <span class="n">zz</span> <span class="o">=</span> <span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">callback</span><span class="p">[:</span><span class="n">exc</span><span class="o">.</span><span class="n">start</span><span class="p">]</span> <span class="o">+</span>
                                  <span class="s1">&#39;?&#39;</span> <span class="o">+</span>
                                  <span class="n">script</span><span class="o">.</span><span class="n">callback</span><span class="p">[</span><span class="n">exc</span><span class="o">.</span><span class="n">end</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
                            <span class="n">cnode</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;callback&quot;</span><span class="p">)</span>
                            <span class="n">cnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Add the script content</span>
                    <span class="n">cnode</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span>
                    <span class="n">cnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">content</span>
                    
                    <span class="c1"># Add the script execution log</span>
                    <span class="n">cnode</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">)</span>
                    <span class="n">cnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">out</span>
                    
                    <span class="k">if</span> <span class="s1">&#39;amend&#39;</span> <span class="ow">in</span> <span class="n">script</span><span class="p">:</span>
                        <span class="n">cnode</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;amend&quot;</span><span class="p">)</span>
                        <span class="n">cnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">amend</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;exec_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;?&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;exec_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">script</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">tn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">res</span>

                    <span class="k">if</span> <span class="s2">&quot;amend&quot;</span> <span class="ow">in</span> <span class="n">script</span><span class="p">:</span>
                        <span class="n">amend_test</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">amend</span><span class="p">,</span> <span class="s2">&quot;atest&quot;</span><span class="p">)</span>
                        <span class="n">amend_test</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
                                                                 <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                                                 <span class="n">script</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">amend_test</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">amend</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                                                                        <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>

                    <span class="c1"># calculate status</span>
                    <span class="n">nb</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">res</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">OK_STATUS</span><span class="p">:</span> <span class="n">nb_pass</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">script</span><span class="o">.</span><span class="n">res</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">TIMEOUT_STATUS</span><span class="p">:</span> <span class="n">nb_timeout</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">script</span><span class="o">.</span><span class="n">res</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">KO_STATUS</span><span class="p">:</span> <span class="n">nb_failed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">nb_not_run</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="s2">&quot;known_error&quot;</span> <span class="ow">in</span> <span class="n">script</span><span class="p">:</span>
                        <span class="n">kf_script</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">known_errors</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
                        <span class="n">kf_script</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
                                                                <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                                                <span class="n">script</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">kf_script</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">known_error</span><span class="o">.</span><span class="n">date</span>
                        <span class="n">kf_script</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span>
                                    <span class="s1">&#39;expected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">known_error</span><span class="o">.</span><span class="n">expected</span>
                        <span class="n">kf_script</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span>
                         <span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">known_error</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
                        <span class="n">kf_script</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                                                       <span class="n">script</span><span class="o">.</span><span class="n">known_error</span><span class="o">.</span><span class="n">fixed</span><span class="p">)</span>
                        <span class="n">overdue</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-&quot;</span>
                                            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">script</span><span class="o">.</span><span class="n">known_error</span><span class="o">.</span><span class="n">expected</span>
                        <span class="k">if</span> <span class="n">overdue</span><span class="p">:</span>
                            <span class="n">kf_script</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;overdue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">overdue</span><span class="p">)</span>
                        
                    <span class="k">elif</span> <span class="n">script</span><span class="o">.</span><span class="n">res</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">KO_STATUS</span><span class="p">:</span>
                        <span class="n">new_err</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">new_errors</span><span class="p">,</span> <span class="s2">&quot;new_error&quot;</span><span class="p">)</span>
                        <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
                                                   <span class="n">test</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">script</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">new_err</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script_path</span>
                        <span class="n">new_err</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sat testerror </span><span class="si">%s</span><span class="s2"> -s </span><span class="si">%s</span><span class="s2"> -c &#39;my&quot;</span>
                                                 <span class="s2">&quot; comment&#39; -p </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">application_name</span><span class="p">,</span> <span class="n">script_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">dist</span><span class="p">))</span>


            <span class="n">gn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
            <span class="n">gn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_pass</span><span class="p">)</span>
            <span class="n">gn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_failed</span><span class="p">)</span>
            <span class="n">gn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_timeout</span><span class="p">)</span>
            <span class="n">gn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;not_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_not_run</span><span class="p">)</span>
            
            <span class="c1"># Remove the res attribute of all tests that were not launched </span>
            <span class="c1"># this time</span>
            <span class="k">for</span> <span class="n">mn</span> <span class="ow">in</span> <span class="n">gn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;executed_last_time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tyn</span> <span class="ow">in</span> <span class="n">mn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">tyn</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;executed_last_time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">test_node</span> <span class="ow">in</span> <span class="n">tyn</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="s2">&quot;res&quot;</span> <span class="ow">in</span> <span class="n">test_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                                    <span class="n">test_node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;res&quot;</span><span class="p">)</span>          
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xmlname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xmlname</span> <span class="o">=</span> <span class="n">application_name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xmlname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">):</span>
        <span class="n">xmlname</span> <span class="o">+=</span> <span class="s2">&quot;.xml&quot;</span>

    <span class="n">XMLMGR</span><span class="o">.</span><span class="n">write_report</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">xmlname</span><span class="p">),</span> <span class="n">root</span><span class="p">,</span> <span class="s2">&quot;test.xsl&quot;</span><span class="p">)</span>
    <span class="n">XMLMGR</span><span class="o">.</span><span class="n">write_report</span><span class="p">(</span><span class="n">xml_history_path</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s2">&quot;test_history.xsl&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">src</span><span class="o">.</span><span class="n">OK_STATUS</span></div>

<div class="viewcode-block" id="generate_history_xml_path"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.test.generate_history_xml_path">[docs]</a><span class="k">def</span> <span class="nf">generate_history_xml_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">test_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the name of the xml file that contain the history of the tests</span>
<span class="sd">    on the machine with the current APPLICATION and the current test base.</span>
<span class="sd">    </span>
<span class="sd">    :param config: (Config) The global configuration</span>
<span class="sd">    :param test_base: (str) The test base name (or path)</span>
<span class="sd">    :return: (str) the full path of the history xml file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">history_xml_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;APPLICATION&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">history_xml_name</span> <span class="o">+=</span> <span class="n">config</span><span class="o">.</span><span class="n">APPLICATION</span><span class="o">.</span><span class="n">name</span>
        <span class="n">history_xml_name</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> 
    <span class="n">history_xml_name</span> <span class="o">+=</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">dist</span>
    <span class="n">history_xml_name</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span>
    <span class="n">test_base_name</span> <span class="o">=</span> <span class="n">test_base</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_base</span><span class="p">):</span>
        <span class="n">test_base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">test_base</span><span class="p">)</span>
    <span class="n">history_xml_name</span> <span class="o">+=</span> <span class="n">test_base_name</span>
    <span class="n">history_xml_name</span> <span class="o">+=</span> <span class="s2">&quot;.xml&quot;</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">UTS</span><span class="o">.</span><span class="n">get_log_path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s2">&quot;TEST&quot;</span><span class="p">,</span> <span class="n">history_xml_name</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/sat_v5.0.png" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../commands.html">commands</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, CEA.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.9</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>