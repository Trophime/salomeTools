<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>commands.jobs &#8212; salomeTools 5.0.0dev documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.0.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="salomeTools 5.0.0dev documentation" href="../../index.html" />
    <link rel="up" title="commands" href="../commands.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for commands.jobs</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*- coding:utf-8 -*-</span>

<span class="c1">#  Copyright (C) 2010-2012  CEA/DEN</span>
<span class="c1">#</span>
<span class="c1">#  This library is free software; you can redistribute it and/or</span>
<span class="c1">#  modify it under the terms of the GNU Lesser General Public</span>
<span class="c1">#  License as published by the Free Software Foundation; either</span>
<span class="c1">#  version 2.1 of the License.</span>
<span class="c1">#</span>
<span class="c1">#  This library is distributed in the hope that it will be useful,</span>
<span class="c1">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c1">#  Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#  You should have received a copy of the GNU Lesser General Public</span>
<span class="c1">#  License along with this library; if not, write to the Free Software</span>
<span class="c1">#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># import paramiko later</span>
  
<span class="kn">import</span> <span class="nn">src.ElementTree</span> <span class="k">as</span> <span class="nn">etree</span>
<span class="kn">import</span> <span class="nn">src.debug</span> <span class="k">as</span> <span class="nn">DBG</span>
<span class="kn">import</span> <span class="nn">src.returnCode</span> <span class="k">as</span> <span class="nn">RCO</span>
<span class="kn">import</span> <span class="nn">src.utilsSat</span> <span class="k">as</span> <span class="nn">UTS</span>
<span class="kn">import</span> <span class="nn">src.pyconf</span> <span class="k">as</span> <span class="nn">PYCONF</span>
<span class="kn">import</span> <span class="nn">src.xmlManager</span> <span class="k">as</span> <span class="nn">XMLMGR</span>
<span class="kn">from</span> <span class="nn">src.salomeTools</span> <span class="k">import</span> <span class="n">_BaseCommand</span>

<span class="n">STYLESHEET_GLOBAL</span> <span class="o">=</span> <span class="s2">&quot;jobs_global_report.xsl&quot;</span>
<span class="n">STYLESHEET_BOARD</span> <span class="o">=</span> <span class="s2">&quot;jobs_board_report.xsl&quot;</span>

<span class="n">DAYS_SEPARATOR</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span>
<span class="n">CSV_DELIMITER</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span>

<span class="n">_PARAMIKO</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="getParamiko"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.getParamiko">[docs]</a><span class="k">def</span> <span class="nf">getParamiko</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_PARAMIKO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">paramiko</span> <span class="k">as</span> <span class="nn">PARAMIKO</span>
      <span class="n">_PARAMIKO</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PARAMIKO</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">PARAMIKO</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Problem import paramiko. No jobs if not &#39;pip install paramiko&#39;&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_PARAMIKO</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
    

<span class="c1">########################################################################</span>
<span class="c1"># Command class</span>
<span class="c1">########################################################################</span>
<div class="viewcode-block" id="Command"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Command">[docs]</a><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">_BaseCommand</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  The jobs command command launches maintenances that are described in </span>
<span class="sd">  the dedicated jobs configuration file.</span>

<span class="sd">  | examples:</span>
<span class="sd">  | &gt;&gt; sat jobs --name my_jobs --publish</span>
<span class="sd">  &quot;&quot;&quot;</span>
  
  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;jobs&quot;</span>
  
<div class="viewcode-block" id="Command.getParser"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Command.getParser">[docs]</a>  <span class="k">def</span> <span class="nf">getParser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define all options for command &#39;sat jobs &lt;options&gt;&#39;&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParserWithHelp</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;list2&#39;</span><span class="p">,</span> <span class="s1">&#39;jobs_cfg&#39;</span><span class="p">,</span> 
        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Mandatory: The name of the config file that contains the jobs configuration. Can be a list.&#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;only_jobs&#39;</span><span class="p">,</span> <span class="s1">&#39;list2&#39;</span><span class="p">,</span> <span class="s1">&#39;only_jobs&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Optional: the list of jobs to launch, by their name. &#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> 
                      <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Optional: list all available config files.&#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;test_connection&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;test_connection&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Optional: try to connect to the machines. Not executing the jobs.&quot;</span><span class="p">),</span>
        <span class="kc">False</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;publish&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;publish&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Optional: generate an xml file that can be read in a browser to display the jobs status.&quot;</span><span class="p">),</span>
        <span class="kc">False</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;input_boards&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;input_boards&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Optional: &quot;</span>
        <span class="s2">&quot;the path to csv file that contain the expected boards.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
        <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;completion&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;no_label&#39;</span><span class="p">,</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Optional (internal use): do not print labels, Works only with --list.&quot;</span><span class="p">),</span>
        <span class="kc">False</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="Command.run"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Command.run">[docs]</a>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_arguments</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;method called for command &#39;sat jobs &lt;options&gt;&#39;&quot;&quot;&quot;</span>
    <span class="n">argList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assumeAsList</span><span class="p">(</span><span class="n">cmd_arguments</span><span class="p">)</span>

    <span class="c1"># print general help and returns</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;No arguments, as &#39;sat </span><span class="si">%s</span><span class="s2"> --help&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      
    <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">,</span> <span class="n">remaindersArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseArguments</span><span class="p">(</span><span class="n">argList</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;Done &#39;sat </span><span class="si">%s</span><span class="s2"> --help&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
   
    <span class="c1"># shortcuts</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRunner</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConfig</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOptions</span><span class="p">()</span>
       
    <span class="n">l_cfg_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PATHS</span><span class="o">.</span><span class="n">JOBPATH</span>
    
    <span class="c1"># list option : display all the available config files</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cfg_dir</span> <span class="ow">in</span> <span class="n">l_cfg_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">no_label</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;------ </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">UTS</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pyconf&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">cfilename</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cfilename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;jobs command done&quot;</span><span class="p">)</span>

    <span class="c1"># Make sure the jobs_config option has been called</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">jobs_cfg</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The option --jobs_config is required</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>      
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;KO&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    
    <span class="c1"># Find the file in the directories, unless it is a full path</span>
    <span class="c1"># merge all in a config</span>
    <span class="n">merger</span> <span class="o">=</span> <span class="n">PYCONF</span><span class="o">.</span><span class="n">ConfigMerger</span><span class="p">()</span>
    <span class="n">config_jobs</span> <span class="o">=</span> <span class="n">PYCONF</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
    <span class="n">l_conf_files_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">config_file</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">jobs_cfg</span><span class="p">:</span>
        <span class="n">found</span><span class="p">,</span> <span class="n">file_jobs_cfg</span> <span class="o">=</span> <span class="n">get_config_file_path</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">l_cfg_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The file configuration </span><span class="si">%s</span><span class="s2"> was not found.</span>
<span class="s2">Use the --list option to get the possible files.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">config_file</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;KO&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">l_conf_files_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_jobs_cfg</span><span class="p">)</span>
        <span class="c1"># Read the config that is in the file</span>
        <span class="n">one_config_jobs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read_config_from_a_file</span><span class="p">(</span><span class="n">file_jobs_cfg</span><span class="p">)</span>
        <span class="n">merger</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">config_jobs</span><span class="p">,</span> <span class="n">one_config_jobs</span><span class="p">)</span>
    
    <span class="n">info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Platform&quot;</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">dist</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Files containing the jobs configuration&quot;</span><span class="p">),</span> <span class="n">l_conf_files_path</span><span class="p">)]</span>    
    <span class="n">UTS</span><span class="o">.</span><span class="n">logger_info_tuples</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">only_jobs</span><span class="p">:</span>
        <span class="n">l_jb</span> <span class="o">=</span> <span class="n">PYCONF</span><span class="o">.</span><span class="n">Sequence</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="n">config_jobs</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">only_jobs</span><span class="p">:</span>
                <span class="n">l_jb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jb</span><span class="p">,</span>
                <span class="s2">&quot;Job that was given in only_jobs option parameters</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config_jobs</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">l_jb</span>
    
    <span class="c1"># Parse the config jobs in order to develop all the factorized jobs</span>
    <span class="n">develop_factorized_jobs</span><span class="p">(</span><span class="n">config_jobs</span><span class="p">)</span>
    
    <span class="c1"># Make a unique file that contain all the jobs in order to use it </span>
    <span class="c1"># on every machine</span>
    <span class="n">name_pyconf</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;.pyconf&#39;</span><span class="p">)]</span> 
                            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">l_conf_files_path</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.pyconf&quot;</span>
    <span class="n">path_pyconf</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get_tmp_filename</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name_pyconf</span><span class="p">)</span>
    <span class="c1">#Save config</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span> <span class="n">path_pyconf</span> <span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">config_jobs</span><span class="o">.</span><span class="n">__save__</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="c1"># log the paramiko problems</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">UTS</span><span class="o">.</span><span class="n">get_log_path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">paramiko_log_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s2">&quot;JOBS&quot;</span><span class="p">)</span>
    <span class="n">UTS</span><span class="o">.</span><span class="n">ensure_path_exists</span><span class="p">(</span><span class="n">paramiko_log_dir_path</span><span class="p">)</span>
    <span class="n">paramiko</span> <span class="o">=</span> <span class="n">getParamiko</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">paramiko</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">log_to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paramiko_log_dir_path</span><span class="p">,</span>
                                           <span class="n">logger</span><span class="o">.</span><span class="n">txtFileName</span><span class="p">))</span>
    
    <span class="c1"># Initialization</span>
    <span class="n">today_jobs</span> <span class="o">=</span> <span class="n">Jobs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">path_pyconf</span><span class="p">,</span> <span class="n">config_jobs</span><span class="p">)</span>
    
    <span class="c1"># SSH connection to all machines</span>
    <span class="n">today_jobs</span><span class="o">.</span><span class="n">ssh_connection_all_machines</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test_connection</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;jobs ssh_connection done&quot;</span><span class="p">)</span>
    
    <span class="n">gui</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">publish</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Initialize the xml boards : &quot;</span><span class="p">))</span>

        <span class="c1"># Copy the stylesheets in the log directory </span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">log_dir</span>
        <span class="n">xsl_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">srcDir</span><span class="p">,</span> <span class="s1">&#39;xsl&#39;</span><span class="p">)</span>
        <span class="n">files_to_copy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xsl_dir</span><span class="p">,</span> <span class="n">STYLESHEET_GLOBAL</span><span class="p">))</span>
        <span class="n">files_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xsl_dir</span><span class="p">,</span> <span class="n">STYLESHEET_BOARD</span><span class="p">))</span>
        <span class="n">files_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xsl_dir</span><span class="p">,</span> <span class="s2">&quot;command.xsl&quot;</span><span class="p">))</span>
        <span class="n">files_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xsl_dir</span><span class="p">,</span> <span class="s2">&quot;running.gif&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_to_copy</span><span class="p">:</span>
            <span class="c1"># OP We use copy instead of copy2 to update the creation date</span>
            <span class="c1">#    So we can clean the LOGS directories easily</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">)</span>
        
        <span class="c1"># Instanciate the Gui in order to produce the xml files that contain all</span>
        <span class="c1"># the boards</span>
        <span class="n">gui</span> <span class="o">=</span> <span class="n">Gui</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span>
                  <span class="n">today_jobs</span><span class="o">.</span><span class="n">ljobs</span><span class="p">,</span>
                  <span class="n">today_jobs</span><span class="o">.</span><span class="n">ljobs_not_today</span><span class="p">,</span>
                  <span class="n">config</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">datehour</span><span class="p">,</span>
                  <span class="n">logger</span><span class="p">,</span>
                  <span class="n">file_boards</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">input_boards</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&lt;OK&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Display the list of the xml files</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;List of published files:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">gui</span><span class="o">.</span><span class="n">xml_global_file</span><span class="o">.</span><span class="n">logFile</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">board</span> <span class="ow">in</span> <span class="n">gui</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">gui</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">logFile</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file_path</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">board</span><span class="p">)</span>
              
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
    <span class="n">today_jobs</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">gui</span>
    
    <span class="n">interruped</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Run all the jobs contained in config_jobs</span>
        <span class="n">today_jobs</span><span class="o">.</span><span class="n">run_jobs</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">interruped</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;KeyboardInterrupt forced interruption&quot;</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="c1"># verbose debug message with traceback</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Exception raised, the jobs loop has been interrupted:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">UTS</span><span class="o">.</span><span class="n">yellow</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>    
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># make clear kill subprocess</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;jobs command finally done&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interruped</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Killing the running jobs and trying to get the corresponding logs</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;KO&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            
        <span class="c1"># find the potential not finished jobs and kill them</span>
        <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="n">today_jobs</span><span class="o">.</span><span class="n">ljobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">jb</span><span class="o">.</span><span class="n">has_finished</span><span class="p">():</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;KO&quot;</span><span class="p">,</span> <span class="s2">&quot;job </span><span class="si">%s</span><span class="s2"> has not finished&quot;</span> <span class="o">%</span> <span class="n">jb</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jb</span><span class="o">.</span><span class="n">kill_remote_process</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Failed to kill job </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">jb</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
                    <span class="n">res</span> <span class="o">+=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;KO&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">res_job</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;KO&quot;</span><span class="p">,</span> <span class="s2">&quot;job </span><span class="si">%s</span><span class="s2"> fail&quot;</span> <span class="o">%</span> <span class="n">jb</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interruped</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">today_jobs</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
                <span class="n">today_jobs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">last_update</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Forced interruption&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">today_jobs</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
                <span class="n">today_jobs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">last_update</span><span class="p">()</span>
        <span class="c1"># Output the results</span>
        <span class="n">today_jobs</span><span class="o">.</span><span class="n">write_all_results</span><span class="p">()</span>
        <span class="c1"># Remove the temporary pyconf file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_pyconf</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path_pyconf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div></div>
  

<div class="viewcode-block" id="Machine"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine">[docs]</a><span class="k">class</span> <span class="nc">Machine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage a ssh connection on a machine</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>
                 <span class="n">host</span><span class="p">,</span>
                 <span class="n">user</span><span class="p">,</span>
                 <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
                 <span class="n">passwd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sat_path</span><span class="o">=</span><span class="s2">&quot;salomeTools&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Will be filled after copying SAT on the machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">passwd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sat_path</span> <span class="o">=</span> <span class="n">sat_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramiko</span> <span class="o">=</span> <span class="n">getParamiko</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_successful</span> <span class="o">=</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="Machine.connect"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiate the ssh connection to the remote machine</span>
<span class="sd">        </span>
<span class="sd">        :param logger: The logger instance </span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_successful</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">load_system_host_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                             <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                             <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                             <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AuthenticationException</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">KO_STATUS</span> <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Authentication failed&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramiko</span><span class="o">.</span><span class="n">BadHostKeyException</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">KO_STATUS</span> <span class="o">+</span> 
                       <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The server&#39;s host key could not be verified&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramiko</span><span class="o">.</span><span class="n">SSHException</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;SSHException error connecting or &quot;</span>
                          <span class="s2">&quot;establishing an SSH session&quot;</span><span class="p">))</span>            
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error connecting or establishing an SSH session&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection_successful</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">message</span></div>
    
<div class="viewcode-block" id="Machine.successfully_connected"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.successfully_connected">[docs]</a>    <span class="k">def</span> <span class="nf">successfully_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify if the connection to the remote machine has succeed</span>
<span class="sd">        </span>
<span class="sd">        :param logger: The logger instance </span>
<span class="sd">        :return: (bool) True if the connection has succeed, False if not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_successful</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Ask if the connection</span>
<span class="s2">(name: </span><span class="si">%(1)s</span><span class="s2"> host: </span><span class="si">%(2)s</span><span class="s2">, port: </span><span class="si">%(3)s</span><span class="s2">, user: </span><span class="si">%(4)s</span><span class="s2">) is OK</span>
<span class="s2">whereas there were no connection request&quot;&quot;&quot;</span> <span class="o">%</span> \
   <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">}</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_successful</span></div>

<div class="viewcode-block" id="Machine.copy_sat"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.copy_sat">[docs]</a>    <span class="k">def</span> <span class="nf">copy_sat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sat_local_path</span><span class="p">,</span> <span class="n">job_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy salomeTools to the remote machine in self.sat_path&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># open a sftp connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
            <span class="c1"># Create the sat directory on remote machine if it is not existing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span> <span class="n">ignore_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Put sat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_dir</span><span class="p">(</span><span class="n">sat_local_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span> <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.git&#39;</span><span class="p">])</span>
            <span class="c1"># put the job configuration file in order to make it reachable </span>
            <span class="c1"># on the remote machine</span>
            <span class="n">remote_job_file_name</span> <span class="o">=</span> <span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">job_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">job_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span> <span class="n">remote_job_file_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection_successful</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">return</span> <span class="n">res</span></div>
        
<div class="viewcode-block" id="Machine.put_dir"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.put_dir">[docs]</a>    <span class="k">def</span> <span class="nf">put_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">filters</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uploads the contents of the source directory to the target path.</span>
<span class="sd">        The target directory needs to exists. </span>
<span class="sd">        All sub-directories in source are created under target.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">destination_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>
                <span class="n">linkto</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">linkto</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">destination_path</span><span class="p">,</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">destination_path</span><span class="p">,</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">destination_path</span><span class="p">,</span> <span class="n">ignore_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">put_dir</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machine.mkdir"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.mkdir">[docs]</a>    <span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">511</span><span class="p">,</span> <span class="n">ignore_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        As mkdir by adding an option to not fail if the folder exists </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_existing</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>       </div>
    
<div class="viewcode-block" id="Machine.exec_command"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.exec_command">[docs]</a>    <span class="k">def</span> <span class="nf">exec_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the command on the remote machine</span>
<span class="sd">        </span>
<span class="sd">        :param command: (str) The command to be run</span>
<span class="sd">        :param logger: The logger instance </span>
<span class="sd">        :return: (paramiko.channel.ChannelFile, etc) </span>
<span class="sd">          the stdin, stdout, and stderr of the executing command,</span>
<span class="sd">          as a 3-tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="c1"># Does not wait the end of the command</span>
            <span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramiko</span><span class="o">.</span><span class="n">SSHException</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&lt;KO&gt;: the paramiko server failed to execute the command</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;command: &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">UTS</span><span class="o">.</span><span class="n">yellow</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&lt;KO&gt;: an exception raised on ssh.exec_command:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;command: &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">UTS</span><span class="o">.</span><span class="n">yellow</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Machine.close"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the ssh connection&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
     
<div class="viewcode-block" id="Machine.write_info"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Machine.write_info">[docs]</a>    <span class="k">def</span> <span class="nf">write_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the informations relative to the machine in the logger </span>
<span class="sd">        (terminal traces and log file)</span>
<span class="sd">        </span>
<span class="sd">        :param logger: The logger instance</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">successfully_connected</span><span class="p">(</span><span class="n">logger</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&lt;OK&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&lt;KO&gt;&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;host: </span><span class="si">%s</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;port: </span><span class="si">%s</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;user: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connection </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span> <span class="p">)</span> </div></div>


<div class="viewcode-block" id="Job"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job">[docs]</a><span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to manage one job</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>
                 <span class="n">machine</span><span class="p">,</span>
                 <span class="n">application</span><span class="p">,</span>
                 <span class="n">board</span><span class="p">,</span> 
                 <span class="n">commands</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">,</span>
                 <span class="n">job_file_path</span><span class="p">,</span>
                 <span class="n">logger</span><span class="p">,</span>
                 <span class="n">after</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="n">after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="c1"># The list of log files to download from the remote machine </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_log_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># The remote command status</span>
        <span class="c1"># -1 means that it has not been launched, </span>
        <span class="c1"># 0 means success and 1 means fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res_job</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancelled</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_T0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_begun</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_timouted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdin</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Store the command inputs field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Store the command outputs field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Store the command errors field</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">name_remote_jobs_pyconf</span> <span class="o">=</span> <span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">job_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span> <span class="s2">&quot;sat&quot;</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot; -l &quot;</span> <span class="o">+</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span>
                                     <span class="s2">&quot;list_log_files.txt&quot;</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot; job --jobs_config &quot;</span> <span class="o">+</span> 
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">name_remote_jobs_pyconf</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot; --name &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39; &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>
    
<div class="viewcode-block" id="Job.get_pids"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.get_pids">[docs]</a>    <span class="k">def</span> <span class="nf">get_pids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the pid(s) corresponding to the command that have been launched</span>
<span class="sd">        On the remote machine</span>
<span class="sd">        </span>
<span class="sd">        :return: (list) The list of integers corresponding to the found pids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cmd_pid</span> <span class="o">=</span> <span class="s1">&#39;ps aux | grep &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39;&quot; | awk </span><span class="se">\&#39;</span><span class="s1">{print $2}</span><span class="se">\&#39;</span><span class="s1">&#39;</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">out_pid</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">cmd_pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">pids_cmd</span> <span class="o">=</span> <span class="n">out_pid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">pids_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">only_numbers</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids_cmd</span><span class="p">]</span>
        <span class="n">pids</span><span class="o">+=</span><span class="n">pids_cmd</span>
        <span class="k">return</span> <span class="n">pids</span></div>
    
<div class="viewcode-block" id="Job.kill_remote_process"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.kill_remote_process">[docs]</a>    <span class="k">def</span> <span class="nf">kill_remote_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Kills the process on the remote machine.</span>
<span class="sd">        </span>
<span class="sd">        :return: (str, str) the output of the kill, the error of the kill</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pids</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Unable to get the pid of the command.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            
        <span class="n">cmd_kill</span> <span class="o">=</span> <span class="s2">&quot; ; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="s2">&quot;kill -2 &quot;</span> <span class="o">+</span> <span class="n">pid</span><span class="p">)</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">])</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">out_kill</span><span class="p">,</span> <span class="n">err_kill</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">cmd_kill</span><span class="p">,</span> 
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">out_kill</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">err_kill</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span></div>
            
<div class="viewcode-block" id="Job.has_begun"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.has_begun">[docs]</a>    <span class="k">def</span> <span class="nf">has_begun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the job has already begun</span>
<span class="sd">        </span>
<span class="sd">        :return: (bool) True if the job has already begun</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_begun</span></div>
    
<div class="viewcode-block" id="Job.has_finished"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.has_finished">[docs]</a>    <span class="k">def</span> <span class="nf">has_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the job has already finished </span>
<span class="sd">        (i.e. all the commands have been executed)</span>
<span class="sd">        If it is finished, the outputs are stored in the fields out and err.</span>
<span class="sd">        </span>
<span class="sd">        :return: (bool) True if the job has already finished</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># If the method has already been called and returned True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="c1"># If the job has not begun yet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_begun</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Store the result outputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="c1"># Put end time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># And get the remote command status and log files</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_log_files</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unable to get remote log files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">e</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span></div>
          
<div class="viewcode-block" id="Job.get_log_files"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.get_log_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_log_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the log files produced by the command launched </span>
<span class="sd">        on the remote machine, and put it in the log directory of the user,</span>
<span class="sd">        so they can be accessible from </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Do not get the files if the command is not finished</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_finished</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Trying to get log files whereas the job is not finished.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">return</span>
        
        <span class="c1"># First get the file that contains the list of log files to get</span>
        <span class="n">tmp_file_path</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get_tmp_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;list_log_files.txt&quot;</span><span class="p">)</span>
        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span> <span class="s2">&quot;list_log_files.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">tmp_file_path</span><span class="p">)</span>
        
        <span class="c1"># Read the file and get the result of the command and all the log files</span>
        <span class="c1"># to get</span>
        <span class="n">fstream_tmp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">file_lines</span> <span class="o">=</span> <span class="n">fstream_tmp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">file_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_lines</span><span class="p">]</span>
        <span class="n">fstream_tmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file_path</span><span class="p">)</span>
        
        <span class="k">try</span> <span class="p">:</span>
            <span class="c1"># The first line is the result of the command (0 success or 1 fail)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_job</span> <span class="o">=</span> <span class="n">file_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unable to get status from remote file &#39;</span><span class="si">%(1)s</span><span class="s2">&#39;: </span><span class="si">%(2)s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> \
                        <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="n">remote_path</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">job_path_remote</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># For each command, there is two files to get :</span>
                <span class="c1"># 1- The xml file describing the command and giving the </span>
                <span class="c1"># internal traces.</span>
                <span class="c1"># 2- The txt file containing the system command traces (like </span>
                <span class="c1"># traces produced by the &quot;make&quot; command)</span>
                <span class="c1"># 3- In case of the test command, there is another file to get :</span>
                <span class="c1"># the xml board that contain the test results</span>
                <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">job_path_remote</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dirname</span> <span class="o">!=</span> <span class="s1">&#39;OUT&#39;</span> <span class="ow">and</span> <span class="n">dirname</span> <span class="o">!=</span> <span class="s1">&#39;TEST&#39;</span><span class="p">:</span>
                    <span class="c1"># Case 1-</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logFilePath</span><span class="p">),</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">job_path_remote</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># The first is the job command</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">job_path_remote</span><span class="p">),</span>
                                             <span class="s2">&quot;job&quot;</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">res_job</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span> 
                <span class="k">elif</span> <span class="n">dirname</span> <span class="o">==</span> <span class="s1">&#39;OUT&#39;</span><span class="p">:</span>
                    <span class="c1"># Case 2-</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logFilePath</span><span class="p">),</span>
                                              <span class="s1">&#39;OUT&#39;</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">job_path_remote</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">dirname</span> <span class="o">==</span> <span class="s1">&#39;TEST&#39;</span><span class="p">:</span>
                    <span class="c1"># Case 3-</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logFilePath</span><span class="p">),</span>
                                              <span class="s1">&#39;TEST&#39;</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">job_path_remote</span><span class="p">))</span>
                
                <span class="c1"># Get the file</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_path_remote</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_log_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unable to get </span><span class="si">%(1)s</span><span class="s2"> log file from remote: </span><span class="si">%(2)s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> \
                            <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_path_remote</span><span class="p">),</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>

<div class="viewcode-block" id="Job.has_failed"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.has_failed">[docs]</a>    <span class="k">def</span> <span class="nf">has_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the job has failed. </span>
<span class="sd">        A job is considered as failed if the machine could not be reached,</span>
<span class="sd">        if the remote command failed, </span>
<span class="sd">        or if the job finished with a time out.</span>
<span class="sd">        </span>
<span class="sd">        :return: (bool) True if the job has failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_finished</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">successfully_connected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_timeout</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_job</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="Job.cancel"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In case of a failing job, one has to cancel every job that depend on it.</span>
<span class="sd">        This method put the job as failed and will not be executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelled</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_begun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancelled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This job was not launched because its father has failed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">+=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="Job.is_running"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.is_running">[docs]</a>    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the job commands are running </span>
<span class="sd">        </span>
<span class="sd">        :return: (bool) True if the job is running</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_begun</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_finished</span><span class="p">()</span></div>

<div class="viewcode-block" id="Job.is_timeout"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.is_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">is_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the job commands has finished with timeout </span>
<span class="sd">        </span>
<span class="sd">        :return:  (bool) True if the job has finished with timeout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_timouted</span></div>

<div class="viewcode-block" id="Job.time_elapsed"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.time_elapsed">[docs]</a>    <span class="k">def</span> <span class="nf">time_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the time elapsed since the job launching</span>
<span class="sd">        </span>
<span class="sd">        :return: The number of seconds</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_begun</span><span class="p">():</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">T_now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">T_now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T0</span></div>
    
<div class="viewcode-block" id="Job.check_time"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.check_time">[docs]</a>    <span class="k">def</span> <span class="nf">check_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the job has not exceeded its timeout.</span>
<span class="sd">        If it has, kill the remote command and consider the job as finished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_begun</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_timouted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="p">(</span><span class="n">out_kill</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_remote_process</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;TIMEOUT </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">out_kill</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="s2">&quot;TIMEOUT : </span><span class="si">%s</span><span class="s2"> seconds elapsed</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_log_files</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unable to get remote log files!</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>
            
<div class="viewcode-block" id="Job.total_duration"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.total_duration">[docs]</a>    <span class="k">def</span> <span class="nf">total_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gives the total duration of the job</span>
<span class="sd">        </span>
<span class="sd">        :return: (int) the total duration of the job in seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T0</span></div>
        
<div class="viewcode-block" id="Job.run"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch the job by executing the remote command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Prevent multiple run</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_begun</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A job can only be launched one time&quot;</span><span class="p">)</span>
            <span class="n">msg2</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Trying to launch the job &#39;</span><span class="si">%s</span><span class="s2">&#39; whereas it has already been launched.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="n">UTS</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">msg2</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">RCO</span><span class="o">.</span><span class="n">ReturnCode</span><span class="p">(</span><span class="s2">&quot;KO&quot;</span><span class="p">,</span> <span class="n">msg2</span><span class="p">)</span>
        
        <span class="c1"># Do not execute the command if the machine could not be reached</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">successfully_connected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;N\A&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Connection to machine (name : </span><span class="si">%s</span><span class="s2">, host: </span><span class="si">%s</span><span class="s2">, port:&quot;</span>
                        <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, user: </span><span class="si">%s</span><span class="s2">) has failed</span><span class="se">\n</span><span class="s2">Use the log command &quot;</span>
                        <span class="s2">&quot;to get more information.&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Usual case : Launch the command on remote machine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_T0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stdin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
            <span class="c1"># If the results are not initialized, finish the job</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_has_finished</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;N\A&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="s2">&quot;The server failed to execute the command&quot;</span>
        
        <span class="c1"># Put the beginning flag to true.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_begun</span> <span class="o">=</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="Job.write_results"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.write_results">[docs]</a>    <span class="k">def</span> <span class="nf">write_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display on the terminal all the job&#39;s information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;name : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">:</span> 
          <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;after : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">after</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Time elapsed : </span><span class="si">%4i</span><span class="s2">min </span><span class="si">%2i</span><span class="s2">s </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_duration</span><span class="p">()</span><span class="o">//</span><span class="mi">60</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_duration</span><span class="p">()</span><span class="o">%</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T0</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Begin time : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                   <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T0</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;End time   : </span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                   <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="n">machine_head</span> <span class="o">=</span> <span class="s2">&quot;Informations about connection :</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">underline</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">machine_head</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">machine_head</span><span class="o">+</span><span class="n">underline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">write_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;out : </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Unable to get output</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;err :</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Job.get_status"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Job.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the status of the job (used by the Gui for xml display)</span>
<span class="sd">        </span>
<span class="sd">        :return: (str) The current status of the job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">successfully_connected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;SSH connection KO&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_begun</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;Not launched&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelled</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Cancelled&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;running since &quot;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T0</span><span class="p">))</span>        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_finished</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_timeout</span><span class="p">():</span>
                <span class="k">return</span> <span class="s2">&quot;Timeout since &quot;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span><span class="p">))</span>
            <span class="k">return</span> <span class="s2">&quot;Finished since &quot;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tf</span><span class="p">))</span></div></div>
    
<div class="viewcode-block" id="Jobs"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs">[docs]</a><span class="k">class</span> <span class="nc">Jobs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to manage the jobs to be run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">runner</span><span class="p">,</span>
                 <span class="n">logger</span><span class="p">,</span>
                 <span class="n">job_file_path</span><span class="p">,</span>
                 <span class="n">config_jobs</span><span class="p">,</span>
                 <span class="n">lenght_columns</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="c1"># The jobs configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg_jobs</span> <span class="o">=</span> <span class="n">config_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_file_path</span> <span class="o">=</span> <span class="n">job_file_path</span>
        <span class="c1"># The machine that will be used today</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmachines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The list of machine (hosts, port) that will be used today </span>
        <span class="c1"># (a same host can have several machine instances since there </span>
        <span class="c1"># can be several ssh parameters) </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhosts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The jobs to be launched today </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The jobs that will not be launched today</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ljobs_not_today</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len_columns</span> <span class="o">=</span> <span class="n">lenght_columns</span>
        
        <span class="c1"># the list of jobs that have not been run yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_not_started</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># the list of jobs that have already ran </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_finished</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># the list of jobs that are running </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_running</span> <span class="o">=</span> <span class="p">[]</span> 
                
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_jobs_and_machines</span><span class="p">()</span>
    
<div class="viewcode-block" id="Jobs.define_job"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.define_job">[docs]</a>    <span class="k">def</span> <span class="nf">define_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_def</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a pyconf job definition and a machine (from class machine)</span>
<span class="sd">        and returns the job instance corresponding to the definition.</span>
<span class="sd">        </span>
<span class="sd">        :param job_def: (Mapping a job definition </span>
<span class="sd">        :param machine: (Machine) the machine on which the job will run</span>
<span class="sd">        :return: (Job) The corresponding job in a job class instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cmmnds</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">commands</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;timeout&quot;</span> <span class="ow">in</span> <span class="n">job_def</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="c1"># default timeout = 4h</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">timeout</span>
        <span class="n">after</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;after&#39;</span> <span class="ow">in</span> <span class="n">job_def</span><span class="p">:</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">after</span>
        <span class="n">application</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;application&#39;</span> <span class="ow">in</span> <span class="n">job_def</span><span class="p">:</span>
            <span class="n">application</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">application</span>
        <span class="n">board</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;board&#39;</span> <span class="ow">in</span> <span class="n">job_def</span><span class="p">:</span>
            <span class="n">board</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">board</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;prefix&quot;</span> <span class="ow">in</span> <span class="n">job_def</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">prefix</span>
            
        <span class="k">return</span> <span class="n">Job</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                   <span class="n">machine</span><span class="p">,</span>
                   <span class="n">application</span><span class="p">,</span>
                   <span class="n">board</span><span class="p">,</span>
                   <span class="n">cmmnds</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">job_file_path</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                   <span class="n">after</span> <span class="o">=</span> <span class="n">after</span><span class="p">,</span>
                   <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Jobs.determine_jobs_and_machines"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.determine_jobs_and_machines">[docs]</a>    <span class="k">def</span> <span class="nf">determine_jobs_and_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the pyconf jobs definition and instantiates all</span>
<span class="sd">        the machines and jobs to be done today.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">weekday</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
        <span class="n">host_list</span> <span class="o">=</span> <span class="p">[]</span>
               
        <span class="k">for</span> <span class="n">job_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg_jobs</span><span class="o">.</span><span class="n">jobs</span> <span class="p">:</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;machine&quot;</span> <span class="ow">in</span> <span class="n">job_def</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The job &#39;</span><span class="si">%s</span><span class="s2">&#39; do not have the key &#39;machine&#39;.</span>
<span class="s2">This job is ignored.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">job_def</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">name_machine</span> <span class="o">=</span> <span class="n">job_def</span><span class="o">.</span><span class="n">machine</span>
            
            <span class="n">a_machine</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">mach</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmachines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mach</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name_machine</span><span class="p">:</span>
                    <span class="n">a_machine</span> <span class="o">=</span> <span class="n">mach</span>
                    <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">a_machine</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">machine_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg_jobs</span><span class="o">.</span><span class="n">machines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">machine_def</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name_machine</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;host&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">machine_def</span><span class="p">:</span>
                            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">hostname</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">host</span> <span class="o">=</span> <span class="n">machine_def</span><span class="o">.</span><span class="n">host</span>

                        <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">machine_def</span><span class="p">:</span>
                            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">user</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">user</span> <span class="o">=</span> <span class="n">machine_def</span><span class="o">.</span><span class="n">user</span>

                        <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">machine_def</span><span class="p">:</span>
                            <span class="n">port</span> <span class="o">=</span> <span class="mi">22</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">port</span> <span class="o">=</span> <span class="n">machine_def</span><span class="o">.</span><span class="n">port</span>
            
                        <span class="k">if</span> <span class="s1">&#39;password&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">machine_def</span><span class="p">:</span>
                            <span class="n">passwd</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">passwd</span> <span class="o">=</span> <span class="n">machine_def</span><span class="o">.</span><span class="n">password</span>    
                            
                        <span class="k">if</span> <span class="s1">&#39;sat_path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">machine_def</span><span class="p">:</span>
                            <span class="n">sat_path</span> <span class="o">=</span> <span class="s2">&quot;salomeTools&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sat_path</span> <span class="o">=</span> <span class="n">machine_def</span><span class="o">.</span><span class="n">sat_path</span>
                        
                        <span class="n">a_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span>
                                            <span class="n">machine_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="n">host</span><span class="p">,</span>
                                            <span class="n">user</span><span class="p">,</span>
                                            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                                            <span class="n">passwd</span><span class="o">=</span><span class="n">passwd</span><span class="p">,</span>
                                            <span class="n">sat_path</span><span class="o">=</span><span class="n">sat_path</span>
                                            <span class="p">)</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">lmachines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_machine</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">host_list</span><span class="p">:</span>
                            <span class="n">host_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">a_machine</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The job &#39;</span><span class="si">%(job)s</span><span class="s2">&#39; requires the machine &#39;</span><span class="si">%(machine)s</span><span class="s2">&#39;.</span>
<span class="s2">This machine is not defined in the configuration file.</span>
<span class="s2">The job will not be launched.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;job&quot;</span> <span class="p">:</span> <span class="n">job_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;machine&quot;</span> <span class="p">:</span> <span class="n">name_machine</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">continue</span>
                                  
            <span class="n">a_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_job</span><span class="p">(</span><span class="n">job_def</span><span class="p">,</span> <span class="n">a_machine</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">today</span> <span class="ow">in</span> <span class="n">job_def</span><span class="o">.</span><span class="n">when</span><span class="p">:</span>    
                <span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_job</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># today in job_def.when</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ljobs_not_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_job</span><span class="p">)</span>
               
        <span class="bp">self</span><span class="o">.</span><span class="n">lhosts</span> <span class="o">=</span> <span class="n">host_list</span></div>
        
<div class="viewcode-block" id="Jobs.ssh_connection_all_machines"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.ssh_connection_all_machines">[docs]</a>    <span class="k">def</span> <span class="nf">ssh_connection_all_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do the ssh connection to every machine to be used today.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Establishing connection with all the machines :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmachines</span><span class="p">:</span>
            <span class="c1"># little algorithm in order to display traces</span>
            <span class="n">begin_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Connection to </span><span class="si">%s</span><span class="s2">: &quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">machine</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pad</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">begin_line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">endline</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">endline</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">begin_line</span><span class="p">))</span> <span class="o">*</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            
            <span class="n">step</span> <span class="o">=</span> <span class="s2">&quot;SSH connection&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="n">begin_line</span> <span class="o">+</span> <span class="n">endline</span> <span class="o">+</span> <span class="n">step</span><span class="p">)</span>
            <span class="c1"># the call to the method that initiate the ssh connection</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
            
            <span class="c1"># Copy salomeTools to the remote machine</span>
            <span class="k">if</span> <span class="n">machine</span><span class="o">.</span><span class="n">successfully_connected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">):</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Remove SAT&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_line</span><span class="p">,</span> <span class="n">endline</span><span class="p">,</span> <span class="mi">20</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_line</span><span class="p">,</span> <span class="n">endline</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
                <span class="p">(</span><span class="n">__</span><span class="p">,</span> <span class="n">out_dist</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span>
                            <span class="s2">&quot;rm -rf </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                <span class="n">out_dist</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                
                <span class="n">step</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Copy SAT&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_line</span><span class="p">,</span> <span class="n">endline</span><span class="p">,</span> <span class="mi">20</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_line</span><span class="p">,</span> <span class="n">endline</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>

                <span class="n">res_copy</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">copy_sat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">VARS</span><span class="o">.</span><span class="n">salometoolsway</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">job_file_path</span><span class="p">)</span>

                <span class="c1"># set the local settings of sat on the remote machine using</span>
                <span class="c1"># the init command</span>
                <span class="p">(</span><span class="n">__</span><span class="p">,</span> <span class="n">out_dist</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span>
                                    <span class="s2">&quot;sat init --base default --workdir&quot;</span>
                                    <span class="s2">&quot; default --log_dir default&quot;</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                <span class="n">out_dist</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                
                <span class="c1"># get the remote machine distribution using a sat command</span>
                <span class="p">(</span><span class="n">__</span><span class="p">,</span> <span class="n">out_dist</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">,</span>
                                    <span class="s2">&quot;sat config --value VARS.dist --no_label&quot;</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                <span class="n">machine</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="n">out_dist</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                                                                        <span class="s2">&quot;&quot;</span><span class="p">)</span>
                
                <span class="c1"># Print the status of the copy</span>
                <span class="k">if</span> <span class="n">res_copy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">begin_line</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">endline</span><span class="p">)</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_line</span><span class="p">,</span> <span class="n">endline</span><span class="p">,</span> <span class="s2">&quot;&lt;OK&gt;&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">begin_line</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">endline</span><span class="p">)</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">begin_line</span><span class="p">,</span> <span class="n">endline</span><span class="p">,</span> <span class="s2">&quot;&lt;KO&gt;&quot;</span><span class="p">,</span>
                         <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Copy of SAT failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">res_copy</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> 
                                  <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">begin_line</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">endline</span><span class="p">)</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%s%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_line</span><span class="p">,</span> <span class="n">endline</span><span class="p">,</span> <span class="s2">&quot;&lt;KO&gt;&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="Jobs.is_occupied"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.is_occupied">[docs]</a>    <span class="k">def</span> <span class="nf">is_occupied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if a job is running on </span>
<span class="sd">        the machine defined by its host and its port.</span>
<span class="sd">        </span>
<span class="sd">        :param hostname: (str, int) the pair (host, port)</span>
<span class="sd">        :return: (Job or bool) </span>
<span class="sd">          the job that is running on the host, </span>
<span class="sd">          or false if there is no job running on the host. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">jb</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">jb</span>
        <span class="k">return</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="Jobs.update_jobs_states_list"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.update_jobs_states_list">[docs]</a>    <span class="k">def</span> <span class="nf">update_jobs_states_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the lists that store the currently</span>
<span class="sd">        running jobs and the jobs that have already finished.</span>
<span class="sd">        </span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs_finished_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">jobs_running_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="n">jobs_running_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jb</span><span class="p">)</span>
                <span class="n">jb</span><span class="o">.</span><span class="n">check_time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">has_finished</span><span class="p">():</span>
                <span class="n">jobs_finished_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jb</span><span class="p">)</span>
        
        <span class="n">nb_job_finished_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_finished</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_finished</span> <span class="o">=</span> <span class="n">jobs_finished_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_running</span> <span class="o">=</span> <span class="n">jobs_running_list</span>
        
        <span class="n">nb_job_finished_now</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_finished</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">nb_job_finished_now</span> <span class="o">&gt;</span> <span class="n">nb_job_finished_before</span></div>
    
<div class="viewcode-block" id="Jobs.cancel_dependencies_of_failing_jobs"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.cancel_dependencies_of_failing_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_dependencies_of_failing_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancels all the jobs that depend on a failing one.</span>
<span class="sd">        </span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">after</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">father_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_job_that_has_name</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">father_job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">father_job</span><span class="o">.</span><span class="n">has_failed</span><span class="p">():</span>
                <span class="n">job</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Jobs.find_job_that_has_name"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.find_job_that_has_name">[docs]</a>    <span class="k">def</span> <span class="nf">find_job_that_has_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the job by its name.</span>
<span class="sd">        </span>
<span class="sd">        :param name: (str) a job name</span>
<span class="sd">        :return: (Job) the job that has the name. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jb</span>
        <span class="c1"># the following is executed only if the job was not found</span>
        <span class="k">return</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Jobs.str_of_length"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.str_of_length">[docs]</a>    <span class="k">def</span> <span class="nf">str_of_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a string text of any length and returns </span>
<span class="sd">        the most close string of length &quot;length&quot;.</span>
<span class="sd">        </span>
<span class="sd">        :param text: (str) any string</span>
<span class="sd">        :param length: (int) a length for the returned string</span>
<span class="sd">        :return: (str) the most close string of length &quot;length&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">text_out</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">length</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">before</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">after</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">diff</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">text_out</span> <span class="o">=</span> <span class="n">before</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="n">after</span>
            
        <span class="k">return</span> <span class="n">text_out</span></div>
    
<div class="viewcode-block" id="Jobs.display_status"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.display_status">[docs]</a>    <span class="k">def</span> <span class="nf">display_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">len_col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a lenght and construct the display of the current status </span>
<span class="sd">        of the jobs in an array that has a column for each host.</span>
<span class="sd">        It displays the job that is currently running on the host of the column.</span>
<span class="sd">        </span>
<span class="sd">        :param len_col: (int) the size of the column </span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="n">display_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">host_port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhosts</span><span class="p">:</span>
            <span class="n">jb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_occupied</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">jb</span><span class="p">:</span> <span class="c1"># nothing running on the host</span>
                <span class="n">empty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_of_length</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="n">len_col</span><span class="p">)</span>
                <span class="n">display_line</span> <span class="o">+=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">empty</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">display_line</span> <span class="o">+=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">UTS</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">str_of_length</span><span class="p">(</span><span class="n">jb</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">len_col</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">display_line</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="Jobs.run_jobs"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.run_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main method. Runs all the jobs on every host. </span>
<span class="sd">        For each host, at a given time, only one job can be running.</span>
<span class="sd">        The jobs that have the field after (that contain the job that has</span>
<span class="sd">        to be run before it) are run after the previous job.</span>
<span class="sd">        This method stops when all the jobs are finished.</span>
<span class="sd">        </span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Print header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Executing the jobs :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">text_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">host_port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhosts</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">host_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">host_port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">port</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span> <span class="c1"># default value</span>
                <span class="n">text_line</span> <span class="o">+=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_of_length</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_columns</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text_line</span> <span class="o">+=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_of_length</span><span class="p">(</span>
                                <span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="n">host</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_columns</span><span class="p">)</span>
        
        <span class="n">tiret_line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">tiret_line</span> <span class="o">+</span> <span class="n">text_line</span> <span class="o">+</span> <span class="s2">&quot;|</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">tiret_line</span><span class="p">)</span>
        
        <span class="c1"># The infinite loop that runs the jobs</span>
        <span class="n">l_jobs_not_started</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">deepcopy_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l_jobs_finished</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">):</span>
            <span class="n">new_job_start</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">host_port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhosts</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_occupied</span><span class="p">(</span><span class="n">host_port</span><span class="p">):</span>
                    <span class="k">continue</span>
             
                <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="n">l_jobs_not_started</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">jb</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">jb</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="n">host_port</span><span class="p">:</span>
                        <span class="k">continue</span> 
                    <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">after</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">jb</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                        <span class="n">l_jobs_not_started</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jb</span><span class="p">)</span>
                        <span class="n">new_job_start</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jb_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_job_that_has_name</span><span class="p">(</span><span class="n">jb</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jb_before</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">jb</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This job was not launched because its &quot;</span>
                                    <span class="s2">&quot;father is not in the jobs list.&quot;</span><span class="p">)</span>
                            <span class="n">jb</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">msg</span>
                            <span class="n">jb</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">msg</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">jb_before</span><span class="o">.</span><span class="n">has_finished</span><span class="p">():</span>
                            <span class="n">jb</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                            <span class="n">l_jobs_not_started</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jb</span><span class="p">)</span>
                            <span class="n">new_job_start</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cancel_dependencies_of_failing_jobs</span><span class="p">()</span>
            <span class="n">new_job_finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_jobs_states_list</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">new_job_start</span> <span class="ow">or</span> <span class="n">new_job_finished</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">update_xml_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">)</span>            
                <span class="c1"># Display the current status     </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">len_columns</span><span class="p">)</span>
            
            <span class="c1"># Make sure that the proc is not entirely busy</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">tiret_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">update_xml_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">last_update</span><span class="p">()</span></div>

<div class="viewcode-block" id="Jobs.write_all_results"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Jobs.write_all_results">[docs]</a>    <span class="k">def</span> <span class="nf">write_all_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display all the jobs outputs.</span>
<span class="sd">        </span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ljobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#------- Results for job </span><span class="si">%s</span><span class="s2"> -------#</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jb</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">jb</span><span class="o">.</span><span class="n">write_results</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Gui"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui">[docs]</a><span class="k">class</span> <span class="nc">Gui</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to manage the the xml data that can be displayed in a browser </span>
<span class="sd">    to see the jobs states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">xml_dir_path</span><span class="p">,</span>
                 <span class="n">l_jobs</span><span class="p">,</span>
                 <span class="n">l_jobs_not_today</span><span class="p">,</span>
                 <span class="n">prefix</span><span class="p">,</span>
                 <span class="n">logger</span><span class="p">,</span>
                 <span class="n">file_boards</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization</span>
<span class="sd">        </span>
<span class="sd">        :param xml_dir_path: (str) </span>
<span class="sd">          The path to the directory where to put the xml resulting files</span>
<span class="sd">        :param l_jobs: (list) the list of jobs that run today</span>
<span class="sd">        :param l_jobs_not_today: (list) </span>
<span class="sd">          the list of jobs that do not run today</span>
<span class="sd">        :param file_boards: (str) </span>
<span class="sd">          the file path from which to read the expected boards</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The logging instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        
        <span class="c1"># The prefix to add to the xml files : date_hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        
        <span class="c1"># The path of the csv files to read to fill the expected boards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_boards</span> <span class="o">=</span> <span class="n">file_boards</span>
        
        <span class="k">if</span> <span class="n">file_boards</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">weekday</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_csv_boards</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># The path of the global xml file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml_dir_path</span> <span class="o">=</span> <span class="n">xml_dir_path</span>
        <span class="c1"># Initialize the xml files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_name</span> <span class="o">=</span> <span class="s2">&quot;global_report&quot;</span>
        <span class="n">xml_global_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_dir_path</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">global_name</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml_global_file</span> <span class="o">=</span> <span class="n">XMLMGR</span><span class="o">.</span><span class="n">XmlLogFile</span><span class="p">(</span><span class="n">xml_global_path</span><span class="p">,</span> <span class="s2">&quot;JobsReport&quot;</span><span class="p">)</span>

        <span class="c1"># Find history for each job</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_history</span><span class="p">(</span><span class="n">l_jobs</span><span class="p">,</span> <span class="n">l_jobs_not_today</span><span class="p">)</span>

        <span class="c1"># The xml files that corresponds to the boards.</span>
        <span class="c1"># {name_board : xml_object}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create the lines and columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_boards</span><span class="p">(</span><span class="n">l_jobs</span><span class="p">,</span> <span class="n">l_jobs_not_today</span><span class="p">)</span>

        <span class="c1"># Write the xml file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_xml_files</span><span class="p">(</span><span class="n">l_jobs</span><span class="p">)</span>
    
<div class="viewcode-block" id="Gui.add_xml_board"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.add_xml_board">[docs]</a>    <span class="k">def</span> <span class="nf">add_xml_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a board to the board list</span>
<span class="sd">        </span>
<span class="sd">        :param name: (str) the board name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xml_board_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_dir_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span>  <span class="n">XMLMGR</span><span class="o">.</span><span class="n">XmlLogFile</span><span class="p">(</span><span class="n">xml_board_path</span><span class="p">,</span><span class="s2">&quot;JobsReport&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add_simple_node</span><span class="p">(</span><span class="s2">&quot;distributions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add_simple_node</span><span class="p">(</span><span class="s2">&quot;applications&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add_simple_node</span><span class="p">(</span><span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>
           
<div class="viewcode-block" id="Gui.initialize_boards"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.initialize_boards">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_boards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_jobs</span><span class="p">,</span> <span class="n">l_jobs_not_today</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the first information needed for each file and write the </span>
<span class="sd">        first version of the files </span>
<span class="sd">        </span>
<span class="sd">        :param l_jobs: (list) the list of jobs that run today</span>
<span class="sd">        :param l_jobs_not_today: (list) the list of jobs that do not run today</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the boards to fill and put it in a dictionary</span>
        <span class="c1"># {board_name : xml instance corresponding to the board}</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">l_jobs</span> <span class="o">+</span> <span class="n">l_jobs_not_today</span><span class="p">:</span>
            <span class="n">board</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">board</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">board</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
                                <span class="n">board</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_xml_board</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Verify that the boards given as input are done</span>
        <span class="k">for</span> <span class="n">board</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">board</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_xml_board</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
            <span class="n">root_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">xmlroot</span>
            <span class="n">XMLMGR</span><span class="o">.</span><span class="n">append_node_attrib</span><span class="p">(</span><span class="n">root_node</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;input_file&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_boards</span><span class="p">})</span>
        
        <span class="c1"># Loop over all jobs in order to get the lines and columns for each </span>
        <span class="c1"># xml file</span>
        <span class="n">d_dist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d_application</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">board</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">:</span>
            <span class="n">d_dist</span><span class="p">[</span><span class="n">board</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">d_application</span><span class="p">[</span><span class="n">board</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            
        <span class="n">l_hosts_ports</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">ASNODE</span> <span class="o">=</span> <span class="n">XMLMGR</span><span class="o">.</span><span class="n">add_simple_node</span> <span class="c1"># shortcut</span>
            
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">l_jobs</span> <span class="o">+</span> <span class="n">l_jobs_not_today</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_hosts_ports</span><span class="p">:</span>
                <span class="n">l_hosts_ports</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                
            <span class="n">distrib</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">distribution</span>
            <span class="n">application</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">application</span>
            
            <span class="n">board_job</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">board</span>
            <span class="k">if</span> <span class="n">board</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">board</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">board_job</span> <span class="o">==</span> <span class="n">board</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">distrib</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="ow">and</span> 
                                            <span class="n">distrib</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_dist</span><span class="p">[</span><span class="n">board</span><span class="p">]):</span>
                        <span class="n">d_dist</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distrib</span><span class="p">)</span>
                        <span class="n">ASNODE</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;distributions&#39;</span><span class="p">),</span>
                                <span class="s2">&quot;dist&quot;</span><span class="p">,</span>  <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">distrib</span><span class="p">}</span> <span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">board_job</span> <span class="o">==</span> <span class="n">board</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">application</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="ow">and</span> 
                                    <span class="n">application</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_application</span><span class="p">[</span><span class="n">board</span><span class="p">]):</span>
                        <span class="n">d_application</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
                        <span class="n">ASNODE</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;applications&#39;</span><span class="p">),</span>
                                <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">application</span><span class="p">}</span> <span class="p">)</span>
        
        <span class="c1"># Verify that there are no missing application or distribution in the</span>
        <span class="c1"># xml board files (regarding the input boards)</span>
        <span class="k">for</span> <span class="n">board</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">:</span>
            <span class="n">l_dist</span> <span class="o">=</span> <span class="n">d_dist</span><span class="p">[</span><span class="n">board</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">board</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="p">[</span><span class="n">board</span><span class="p">][</span><span class="s2">&quot;rows&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_dist</span><span class="p">:</span>
                    <span class="n">ASNODE</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;distributions&#39;</span><span class="p">),</span>
                            <span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">dist</span><span class="p">}</span> <span class="p">)</span>
            <span class="n">l_appli</span> <span class="o">=</span> <span class="n">d_application</span><span class="p">[</span><span class="n">board</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">appli</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="p">[</span><span class="n">board</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">appli</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_appli</span><span class="p">:</span>
                    <span class="n">ASNODE</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;applications&#39;</span><span class="p">),</span>
                            <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">appli</span><span class="p">}</span> <span class="p">)</span>
                
        <span class="c1"># Initialize the hosts_ports node for the global file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmlhosts_ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_global_file</span><span class="o">.</span><span class="n">add_simple_node</span><span class="p">(</span> <span class="s2">&quot;hosts_ports&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">l_hosts_ports</span><span class="p">:</span>
            <span class="n">host_port</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmlhosts_ports</span><span class="p">,</span> <span class="s2">&quot;host_port&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">host_port</span><span class="p">})</span>
        
        <span class="c1"># Initialize the jobs node in all files</span>
        <span class="k">for</span> <span class="n">xml_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_global_file</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">xml_jobs</span> <span class="o">=</span> <span class="n">xml_file</span><span class="o">.</span><span class="n">add_simple_node</span><span class="p">(</span><span class="s2">&quot;jobs&quot;</span><span class="p">)</span>      
            <span class="c1"># Get the jobs present in the config file but </span>
            <span class="c1"># that will not be launched today</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_jobs_not_today</span><span class="p">(</span><span class="n">l_jobs_not_today</span><span class="p">,</span> <span class="n">xml_jobs</span><span class="p">)</span>
            
            <span class="c1"># add also the infos node</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">add_simple_node</span><span class="p">(</span> 
                <span class="s2">&quot;infos&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;last update&quot;</span><span class="p">,</span> <span class="s2">&quot;JobsCommandStatus&quot;</span> <span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">}</span> <span class="p">)</span>
            
            <span class="c1"># and put the history node</span>
            <span class="n">history_node</span> <span class="o">=</span> <span class="n">xml_file</span><span class="o">.</span><span class="n">add_simple_node</span><span class="p">(</span><span class="s2">&quot;history&quot;</span><span class="p">)</span>
            <span class="n">name_board</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">xml_file</span><span class="o">.</span><span class="n">logFile</span><span class="p">)[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)]</span>
            <span class="c1"># serach for board files</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;^[0-9]</span><span class="si">{8}</span><span class="s2">_+[0-9]</span><span class="si">{6}</span><span class="s2">_&quot;</span> <span class="o">+</span> <span class="n">name_board</span> <span class="o">+</span> <span class="s2">&quot;.xml$&quot;</span>
            <span class="n">oExpr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
            <span class="c1"># Get the list of xml borad files that are in the log directory</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_dir_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">oExpr</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_dir_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="n">ASNODE</span><span class="p">(</span><span class="n">history_node</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;date&quot;</span> <span class="p">:</span> <span class="n">date</span><span class="p">})</span>      
            
                
        <span class="c1"># Find in each board the squares that needs to be filled regarding the</span>
        <span class="c1"># input csv files but that are not covered by a today job</span>
        <span class="k">for</span> <span class="n">board</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">xml_root_board</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="p">[</span><span class="n">board</span><span class="p">]</span><span class="o">.</span><span class="n">xmlroot</span>
            <span class="c1"># Find the missing jobs for today</span>
            <span class="n">xml_missing</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xml_root_board</span><span class="p">,</span> <span class="s2">&quot;missing_jobs&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="p">[</span><span class="n">board</span><span class="p">][</span><span class="s2">&quot;jobs&quot;</span><span class="p">]:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">l_jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">application</span> <span class="o">==</span> <span class="n">column</span> <span class="ow">and</span> 
                        <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="n">row</span><span class="p">):</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">ASNODE</span><span class="p">(</span><span class="n">xml_missing</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;distribution&quot;</span> <span class="p">:</span> <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span> <span class="p">:</span> <span class="n">column</span> <span class="p">})</span>
            <span class="c1"># Find the missing jobs not today</span>
            <span class="n">xml_missing_not_today</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span> <span class="n">xml_root_board</span><span class="p">,</span> <span class="s2">&quot;missing_jobs_not_today&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="p">[</span><span class="n">board</span><span class="p">][</span><span class="s2">&quot;jobs_not_today&quot;</span><span class="p">]:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">l_jobs_not_today</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">application</span> <span class="o">==</span> <span class="n">column</span> <span class="ow">and</span> 
                        <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="n">row</span><span class="p">):</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">ASNODE</span><span class="p">(</span> <span class="n">xml_missing_not_today</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span>
                            <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;distribution&quot;</span> <span class="p">:</span> <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span> <span class="p">:</span> <span class="n">column</span> <span class="p">}</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Gui.find_history"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.find_history">[docs]</a>    <span class="k">def</span> <span class="nf">find_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_jobs</span><span class="p">,</span> <span class="n">l_jobs_not_today</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find, for each job, in the existent xml boards the results for the job.</span>
<span class="sd">        Store the results in the dictionary </span>
<span class="sd">        self.history = {name_job : list of (date, status, list links)}</span>
<span class="sd">        </span>
<span class="sd">        :param l_jobs: (list) </span>
<span class="sd">          the list of jobs to run today   </span>
<span class="sd">        :param l_jobs_not_today: (list) </span>
<span class="sd">          the list of jobs that do not run today</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load the all the history</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;^[0-9]</span><span class="si">{8}</span><span class="s2">_+[0-9]</span><span class="si">{6}</span><span class="s2">_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_name</span> <span class="o">+</span> <span class="s2">&quot;.xml$&quot;</span>
        <span class="n">oExpr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="c1"># Get the list of global xml that are in the log directory</span>
        <span class="n">l_globalxml</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_dir_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">oExpr</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_dir_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">global_xml</span> <span class="o">=</span> <span class="n">XMLMGR</span><span class="o">.</span><span class="n">ReadXmlFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="n">l_globalxml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_xml</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The file &#39;</span><span class="si">%s</span><span class="s2">&#39; can not be read, it will be ignored</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
                    
        <span class="c1"># Construct the dictionnary self.history </span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">l_jobs</span> <span class="o">+</span> <span class="n">l_jobs_not_today</span><span class="p">:</span>
            <span class="n">l_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">global_xml</span> <span class="ow">in</span> <span class="n">l_globalxml</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">global_xml</span><span class="o">.</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">global_root_node</span> <span class="o">=</span> <span class="n">global_xml</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;jobs&quot;</span><span class="p">)</span>
                <span class="n">job_node</span> <span class="o">=</span> <span class="n">XMLMGR</span><span class="o">.</span><span class="n">find_node_by_attrib</span><span class="p">(</span>
                  <span class="n">global_root_node</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">job_node</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;remote_log_file_path&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="n">job_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;remote_log_file_path&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                        <span class="n">res_job</span> <span class="o">=</span> <span class="n">job_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;res&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                        <span class="k">if</span> <span class="n">link</span> <span class="o">!=</span> <span class="s2">&quot;nothing&quot;</span><span class="p">:</span>
                            <span class="n">l_links</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date</span><span class="p">,</span> <span class="n">res_job</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
            <span class="n">l_links</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">l_links</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_links</span></div>
  
<div class="viewcode-block" id="Gui.put_jobs_not_today"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.put_jobs_not_today">[docs]</a>    <span class="k">def</span> <span class="nf">put_jobs_not_today</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_jobs_not_today</span><span class="p">,</span> <span class="n">xml_node_jobs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the first information needed for each file and write the </span>
<span class="sd">        first version of the files   </span>

<span class="sd">        :param xml_node_jobs: (etree.Element) </span>
<span class="sd">          the node corresponding to a job</span>
<span class="sd">        :param l_jobs_not_today: (list) </span>
<span class="sd">          the list of jobs that do not run today</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">ASNODE</span> <span class="o">=</span> <span class="n">XMLMGR</span><span class="o">.</span><span class="n">add_simple_node</span> <span class="c1"># shortcut</span>
        
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">l_jobs_not_today</span><span class="p">:</span>
            <span class="n">xmlj</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xml_node_jobs</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;distribution&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">distribution</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="s2">&quot; ; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">commands</span><span class="p">))</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;Not today&quot;</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;machine&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;sat_path&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">)</span>
            <span class="n">xml_history</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">res_job</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># tag the first one (the last one)</span>
                    <span class="n">ASNODE</span><span class="p">(</span> <span class="n">xml_history</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">link</span><span class="p">,</span>
                            <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;date&quot;</span> <span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span> <span class="p">:</span> <span class="n">res_job</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span> <span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">}</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ASNODE</span><span class="p">(</span> <span class="n">xml_history</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">link</span><span class="p">,</span>
                            <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;date&quot;</span> <span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span> <span class="p">:</span> <span class="n">res_job</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span> <span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">}</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Gui.parse_csv_boards"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.parse_csv_boards">[docs]</a>    <span class="k">def</span> <span class="nf">parse_csv_boards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">today</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Parse the csv file that describes the boards to produce and fill </span>
<span class="sd">        the dict d_input_boards that contain the csv file contain</span>
<span class="sd">        </span>
<span class="sd">        :param today: (int) the current day of the week </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># open the csv file and read its content</span>
        <span class="n">l_read</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_boards</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="n">CSV_DELIMITER</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">l_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="c1"># get the delimiter for the boards (empty line)</span>
        <span class="n">boards_delimiter</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_read</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Make the list of boards, by splitting with the delimiter</span>
        <span class="n">l_boards</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">l_read</span><span class="p">,</span>
                                    <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span> <span class="o">==</span> <span class="n">boards_delimiter</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">]</span>
           
        <span class="c1"># loop over the csv lists of lines and get the rows, columns and jobs</span>
        <span class="n">d_boards</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">input_board</span> <span class="ow">in</span> <span class="n">l_boards</span><span class="p">:</span>
            <span class="c1"># get board name</span>
            <span class="n">board_name</span> <span class="o">=</span> <span class="n">input_board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Get columns list</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">input_board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">jobs_not_today</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_board</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">square</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="k">if</span> <span class="n">square</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="n">square</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DAYS_SEPARATOR</span><span class="p">)</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">days</span><span class="p">]</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">today</span> <span class="ow">in</span> <span class="n">days</span><span class="p">:</span>                           
                        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jobs_not_today</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

            <span class="n">d_boards</span><span class="p">[</span><span class="n">board_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rows&quot;</span> <span class="p">:</span> <span class="n">rows</span><span class="p">,</span>
                                    <span class="s2">&quot;columns&quot;</span> <span class="p">:</span> <span class="n">columns</span><span class="p">,</span>
                                    <span class="s2">&quot;jobs&quot;</span> <span class="p">:</span> <span class="n">jobs</span><span class="p">,</span>
                                    <span class="s2">&quot;jobs_not_today&quot;</span> <span class="p">:</span> <span class="n">jobs_not_today</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span> <span class="o">=</span> <span class="n">d_boards</span></div>

<div class="viewcode-block" id="Gui.update_xml_files"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.update_xml_files">[docs]</a>    <span class="k">def</span> <span class="nf">update_xml_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_jobs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write all the xml files with updated information about the jobs   </span>

<span class="sd">        :param l_jobs: (list) the list of jobs that run today</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">xml_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_global_file</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_xml_file</span><span class="p">(</span><span class="n">l_jobs</span><span class="p">,</span> <span class="n">xml_file</span><span class="p">)</span>
            
        <span class="c1"># Write the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_xml_files</span><span class="p">()</span></div>
            
<div class="viewcode-block" id="Gui.update_xml_file"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.update_xml_file">[docs]</a>    <span class="k">def</span> <span class="nf">update_xml_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_jobs</span><span class="p">,</span> <span class="n">xml_file</span><span class="p">):</span>      
        <span class="sd">&quot;&quot;&quot;update information about the jobs for the file xml_file   </span>

<span class="sd">        :param l_jobs: (list) the list of jobs that run today</span>
<span class="sd">        :param xml_file: (xmlManager.XmlLogFile) </span>
<span class="sd">          the xml instance to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">xml_node_jobs</span> <span class="o">=</span> <span class="n">xml_file</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">)</span>
        <span class="c1"># Update the job names and status node</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">l_jobs</span><span class="p">:</span>
            <span class="c1"># Find the node corresponding to the job and delete it</span>
            <span class="c1"># in order to recreate it</span>
            <span class="k">for</span> <span class="n">xmljob</span> <span class="ow">in</span> <span class="n">xml_node_jobs</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;job&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">xmljob</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">xml_node_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">xmljob</span><span class="p">)</span>
            
            <span class="n">T0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_T0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">T0</span> <span class="o">!=</span> <span class="s2">&quot;-1&quot;</span><span class="p">:</span>
                <span class="n">T0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> 
                                       <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_T0</span><span class="p">))</span>
            <span class="n">Tf</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_Tf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Tf</span> <span class="o">!=</span> <span class="s2">&quot;-1&quot;</span><span class="p">:</span>
                <span class="n">Tf</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> 
                                       <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">_Tf</span><span class="p">))</span>
            
            <span class="c1"># recreate the job node</span>
            <span class="n">xmlj</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xml_node_jobs</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;machine&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">xml_history</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">res_job</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">ASNODE</span><span class="p">(</span> <span class="n">xml_history</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">link</span><span class="p">,</span>
                        <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;date&quot;</span> <span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span> <span class="p">:</span> <span class="n">res_job</span><span class="p">}</span> <span class="p">)</span>

            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;sat_path&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">sat_path</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;distribution&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">distribution</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;board&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">timeout</span><span class="p">))</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="s2">&quot; ; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">commands</span><span class="p">))</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">get_status</span><span class="p">())</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;begin&quot;</span><span class="p">,</span> <span class="n">T0</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">Tf</span><span class="p">)</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">UTS</span><span class="o">.</span><span class="n">cleancolor</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">out</span><span class="p">))</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">UTS</span><span class="o">.</span><span class="n">cleancolor</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">err</span><span class="p">))</span>
            <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">res_job</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">remote_log_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;remote_log_file_path&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">remote_log_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;remote_log_file_path&quot;</span><span class="p">,</span> <span class="s2">&quot;nothing&quot;</span><span class="p">)</span>           
            <span class="c1"># Search for the test log if there is any</span>
            <span class="n">l_test_log_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_test_log</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">remote_log_files</span><span class="p">)</span>
            <span class="n">xml_test</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;test_log_file_path&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">test_log_path</span><span class="p">,</span> <span class="n">res_test</span><span class="p">,</span> <span class="n">nb_fails</span> <span class="ow">in</span> <span class="n">l_test_log_files</span><span class="p">:</span>
                <span class="n">test_path_node</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xml_test</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">test_log_path</span><span class="p">)</span>
                <span class="n">test_path_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_test</span>
                <span class="n">test_path_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;nb_fails&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_fails</span>
            
            <span class="n">xmlafter</span> <span class="o">=</span> <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
            <span class="c1"># get the job father</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job_father</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="n">l_jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jb</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">after</span><span class="p">:</span>
                        <span class="n">job_father</span> <span class="o">=</span> <span class="n">jb</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">job_father</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
                        <span class="nb">len</span><span class="p">(</span><span class="n">job_father</span><span class="o">.</span><span class="n">remote_log_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">job_father</span><span class="o">.</span><span class="n">remote_log_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="s2">&quot;nothing&quot;</span>
                <span class="n">XMLMGR</span><span class="o">.</span><span class="n">append_node_attrib</span><span class="p">(</span><span class="n">xmlafter</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;link&quot;</span> <span class="p">:</span> <span class="n">link</span><span class="p">})</span>
            
            <span class="c1"># Verify that the job is to be done today regarding the input csv</span>
            <span class="c1"># files</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">board</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">board</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">appli</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_input_boards</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">board</span><span class="p">][</span><span class="s2">&quot;jobs&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="n">dist</span> 
                        <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">application</span> <span class="o">==</span> <span class="n">appli</span><span class="p">):</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;extra_job&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">ASNODE</span><span class="p">(</span><span class="n">xmlj</span><span class="p">,</span> <span class="s2">&quot;extra_job&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>
            
        
        <span class="c1"># Update the date</span>
        <span class="n">xml_node_infos</span> <span class="o">=</span> <span class="n">xml_file</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;infos&#39;</span><span class="p">)</span>
        <span class="n">XMLMGR</span><span class="o">.</span><span class="n">append_node_attrib</span><span class="p">(</span> <span class="n">xml_node_infos</span><span class="p">,</span>
           <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;value&quot;</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)}</span> <span class="p">)</span></div>
               

<div class="viewcode-block" id="Gui.find_test_log"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.find_test_log">[docs]</a>    <span class="k">def</span> <span class="nf">find_test_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_remote_log_files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find if there is a test log (board) in the remote log files and </span>
<span class="sd">        the path to it. There can be several test command, </span>
<span class="sd">        so the result is a list.</span>

<span class="sd">        :param l_remote_log_files: (list) the list of all remote log files</span>
<span class="sd">        :return: (list) </span>
<span class="sd">          the list of tuples (test log files path, res of the command)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">l_remote_log_files</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="n">UTS</span><span class="o">.</span><span class="n">_log_all_command_file_expression</span>
            <span class="n">oExpr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dirname</span> <span class="o">==</span> <span class="s2">&quot;TEST&quot;</span> <span class="ow">and</span> <span class="n">oExpr</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                <span class="c1"># find the res of the command</span>
                <span class="n">prod_node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;product&quot;</span><span class="p">)</span>
                <span class="n">res_test</span> <span class="o">=</span> <span class="n">prod_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;global_res&quot;</span><span class="p">]</span>
                <span class="c1"># find the number of fails</span>
                <span class="n">testbase_node</span> <span class="o">=</span> <span class="n">prod_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;tests&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;testbase&quot;</span><span class="p">)</span>
                <span class="n">nb_fails</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">testbase_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">])</span>
                <span class="c1"># put the file path, the res of the test command and the number </span>
                <span class="c1"># of fails in the output</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">res_test</span><span class="p">,</span> <span class="n">nb_fails</span><span class="p">))</span>
                
        <span class="k">return</span> <span class="n">res</span></div>
    
<div class="viewcode-block" id="Gui.last_update"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.last_update">[docs]</a>    <span class="k">def</span> <span class="nf">last_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finish_status</span> <span class="o">=</span> <span class="s2">&quot;finished&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;update information about the jobs for the file xml_file   </span>

<span class="sd">        :param l_jobs: (list) the list of jobs that run today</span>
<span class="sd">        :param xml_file: (xmlManager.XmlLogFile) the xml instance to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">xml_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_global_file</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">xml_node_infos</span> <span class="o">=</span> <span class="n">xml_file</span><span class="o">.</span><span class="n">xmlroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;infos&#39;</span><span class="p">)</span>
            <span class="n">XMLMGR</span><span class="o">.</span><span class="n">append_node_attrib</span><span class="p">(</span><span class="n">xml_node_infos</span><span class="p">,</span>
                        <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;JobsCommandStatus&quot;</span> <span class="p">:</span> <span class="n">finish_status</span><span class="p">})</span>
        <span class="c1"># Write the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_xml_files</span><span class="p">()</span></div>

<div class="viewcode-block" id="Gui.write_xml_file"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.write_xml_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_xml_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_file</span><span class="p">,</span> <span class="n">stylesheet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write one xml file and the same file with prefix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write_tree</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">xml_file</span><span class="o">.</span><span class="n">logFile</span>
        <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">file_name_with_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">file_name</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write_tree</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span>
                                                     <span class="n">file_name_with_prefix</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="Gui.write_xml_files"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.Gui.write_xml_files">[docs]</a>    <span class="k">def</span> <span class="nf">write_xml_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the xml files   </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_xml_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_global_file</span><span class="p">,</span> <span class="n">STYLESHEET_GLOBAL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">xml_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_xml_board_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_xml_file</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span> <span class="n">STYLESHEET_BOARD</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="get_config_file_path"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.get_config_file_path">[docs]</a><span class="k">def</span> <span class="nf">get_config_file_path</span><span class="p">(</span><span class="n">job_config_name</span><span class="p">,</span> <span class="n">l_cfg_dir</span><span class="p">):</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">file_jobs_cfg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">job_config_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">job_config_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pyconf&quot;</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">file_jobs_cfg</span> <span class="o">=</span> <span class="n">job_config_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cfg_dir</span> <span class="ow">in</span> <span class="n">l_cfg_dir</span><span class="p">:</span>
            <span class="n">file_jobs_cfg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">,</span> <span class="n">job_config_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_jobs_cfg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pyconf&#39;</span><span class="p">):</span>
                <span class="n">file_jobs_cfg</span> <span class="o">+=</span> <span class="s1">&#39;.pyconf&#39;</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_jobs_cfg</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">found</span><span class="p">,</span> <span class="n">file_jobs_cfg</span></div>

<div class="viewcode-block" id="develop_factorized_jobs"><a class="viewcode-back" href="../../apidoc_commands/commands.html#commands.jobs.develop_factorized_jobs">[docs]</a><span class="k">def</span> <span class="nf">develop_factorized_jobs</span><span class="p">(</span><span class="n">config_jobs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;update information about the jobs for the file xml_file   </span>
<span class="sd">    </span>
<span class="sd">    :param config_jobs: (Config) </span>
<span class="sd">      the config corresponding to the jos description</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">developed_jobs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="n">config_jobs</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
        <span class="c1"># case where the jobs are not developed</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">jb</span><span class="o">.</span><span class="n">machine</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">developed_jobs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jb</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Case where the jobs must be developed</span>
        <span class="c1"># Example:</span>
        <span class="c1"># machine : [&quot;CO7.2 physique&quot;, [&quot;CO6.4 physique&quot;, $MONDAY, $TUESDAY ], &quot;FD22&quot;]</span>
        <span class="n">name_job</span> <span class="o">=</span> <span class="n">jb</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">jb</span><span class="o">.</span><span class="n">machine</span><span class="p">:</span>
            <span class="n">new_job</span> <span class="o">=</span> <span class="n">PYCONF</span><span class="o">.</span><span class="n">deepCopyMapping</span><span class="p">(</span><span class="n">jb</span><span class="p">)</span>
            <span class="c1"># case where there is a jobs on the machine corresponding to all</span>
            <span class="c1"># days in when variable. </span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">new_job</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">machine</span>
                <span class="n">new_job</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_job</span> <span class="o">+</span> <span class="s2">&quot; / &quot;</span> <span class="o">+</span> <span class="n">machine</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># case the days are re defined</span>
                <span class="n">new_job</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">machine</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_job</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_job</span> <span class="o">+</span> <span class="s2">&quot; / &quot;</span> <span class="o">+</span> <span class="n">machine</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_job</span><span class="o">.</span><span class="n">when</span> <span class="o">=</span> <span class="n">machine</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">developed_jobs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_job</span><span class="p">)</span>
    
    <span class="n">config_jobs</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">developed_jobs_list</span></div>
            
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/sat_v5.0.png" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../commands.html">commands</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, CEA.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.9</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>